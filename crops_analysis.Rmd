---
title: "crops_analysis"
author: "Roni Yunis"
date: "2023-08-23"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

# 1. Deskripsi

Tujuan penelitian adalah menghasilkan model prediksi tanaman pangan
melalui analisis big data. Temuan dari penelitian ini akan menjadi
landasan penting dalam pembangunan sistem big data nasional yang
difokuskan pada bidang pertanian, sehingga dapat mendukung program
pemerintah dalam pengambilan keputusan untuk meningkatkan ketahanan
pangan nasional. Untuk pengujian dan analisis akan menggunakan dataset
tanaman pangan yang ada di wilayah Sumatera Utara. Data tanaman pangan
yang akan di analisis meliputi: tanaman Jagung, Kacang Hijau, Kacang
Kedelai, Kacang Tanah, Ubi Jalar, Ubi Kayu dan Padi, serta data curah
hujan.

# 2. Load Library

```{r}
library(dplyr)
library(ggplot2)
library(lubridate)
library(summarytools)
library(readxl)
library(cluster)
library(scales)
library(factoextra)
library(mclust)
library(vars)
library(forecast)
library(prophet)
library(caret)
library(timetk)
```

# 3. Data Padi

## Obstain - Load Dataset

```{r}
padi_sumut <- read_excel("dataset/bps-Padi.xlsx")
padi_sumut
```

## Scrub Data

Proses Scrub yang akan dilakukan adalah merubah type data dan menghapus
data yang tidak penting atau data yang kosng (not available).
Berdasarkan data_sumut dapat dilihat bahwa type data dari kolom Tahun
adalah double, rata-rata produksi, produksi dan luas panen bertype
karakter. Maka untuk mendukung proses analisis maka type data Tahun
harus dirubah ke type Date, dan data yg bertype karakter dirubah kedalam
type numeric

### a. Merubah type data

```{r}
# Merubah type data karakter menjadi numeric
padi_sumut$`Rata-rata produksi` <- as.numeric(padi_sumut$`Rata-rata produksi`)
padi_sumut$Produksi <- as.numeric(padi_sumut$Produksi)
padi_sumut$`Luas Panen` <- as.numeric(padi_sumut$`Luas Panen`)
padi_sumut
```

```{r}
# Merubah type Tahun menjadi Date
padi_sumut$Tahun <- make_date(padi_sumut$Tahun)
glimpse(padi_sumut)
```

```{r}
# Merubah nama variabel Kabupaten Kota, Rata-rata Produksi dan Luas Panen
names(padi_sumut)[names(padi_sumut) == "Kabupaten Kota"] <- "Kabupaten_kota"
names(padi_sumut)[names(padi_sumut) == "Rata-rata produksi"] <- "Rata_rata_produksi"
names(padi_sumut)[names(padi_sumut) == "Luas Panen"] <- "Luas_panen"
glimpse(padi_sumut)
```

```{r}
tail(padi_sumut)
head(padi_sumut)
```

### b. Menghapus Data Kosong

```{r}
# Menampikan variabel dengan baris kosong
colSums(is.na(padi_sumut))
```

```{r}
# Menghapus data NA's
padisumut_clean <- na.omit(padi_sumut)
summary(padisumut_clean)
```

```{r}
colSums(is.na(padisumut_clean))
```

Semua data NA's sudah dihapus. Data padi di wilayah sumut mulai dari
Tahun 2010 - 2020 dengan frekuensi data per Tahun. Dalam dataset
padisumut_clean masih terdapat data dari provinsi Sumatera Utara
keseluruhan. Agar memudahkan dalam tahap analisis selanjutnya maka data
padisumut_clean yang diambil hanya berdasarkan kabupaten/kota saja.
Sekarang data final yang siap dianalisis adalah sebanyak 359 baris
observasi dengan 5 kolom variabel

```{r}
padisumutfilter <- padisumut_clean[padisumut_clean$Kabupaten_kota != "Sumatera Utara",]
padisumutfilter
```

## Eksplorasi Data Analisis (EDA)

### Jumlah Produksi Padi per Kabupaten/Kota

```{r}
plot_1 <- ggplot(padisumutfilter, aes(x = Tahun, y = Produksi, group = Kabupaten_kota, color = Kabupaten_kota)) +
  geom_line() +
  labs(title = "Jumlah Produksi Padi", x = "Tahun", y = "Produksi Padi (Ha)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "right")
plot_1

```

```{r}
# Hitung total produksi per kabupaten/kota
totproduksi <- padisumutfilter %>% 
  mutate(first_date_month = floor_date(Tahun, unit = "year")) %>% 
  group_by(Kabupaten_kota) %>% 
  summarise(jumlahproduksi = sum(Produksi)) %>% 
  arrange(jumlahproduksi)
totproduksi
```

```{r}
# Turn off dplyr summarise() warning
options(dplyr.summarise.inform = FALSE)

# Hitung total produksi per kabupaten/tahun
totproduksi <- padisumutfilter %>% 
  group_by(Tahun, Kabupaten_kota, .drop = FALSE) %>%  # Add .drop argument
  summarise(total_produksi = sum(Produksi))

totproduksi
```

### Tren Produksi Padi per Kabupaten/Kota

```{r}
# Visualisasi Tren Produksi Padi
plot_2 <- ggplot(totproduksi, aes(x = Tahun, y = total_produksi, color = Kabupaten_kota)) +
  geom_line() +
  geom_point() +
  labs(title = "Tren Produksi Padi", x = "Tahun", y = "Total Produksi (Ton)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "right")
plot_2
```

### Perbandingan Produksi Padi per Kabupaten/Kota

```{r}

# Hitung total produksi padi per Kabupaten/Kota
totproduksi_kabkota <- padisumutfilter %>% 
  group_by(Kabupaten_kota) %>% 
  summarise(total_produksi = sum(Produksi))

# Visualisasi dengan barplot
plot_3 <- ggplot(totproduksi_kabkota, aes(x = Kabupaten_kota, y = total_produksi, fill = Kabupaten_kota)) +
  geom_bar(stat = "identity") +
  labs(title = "Perbandingan Produksi Padi antara Kabupaten/Kota", x = "Kabupaten/Kota", y = "Total Produksi (Ton)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "none")  # hilangkan legend

# Rotasi sumbu x agar mudah dibaca
plot_3 + theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

Perbandingan produksi padi dalam kurun waktu 2010 - 2020 adalah dari
Kabupaten Simalungun yang terbanyak dengan Jumlah Produksi Padi sebesar
4814941.97 Ton

### Perbandingan Rata-rata produksi Padi per Kabupaten/Kota

```{r}
# Turn off dplyr summarise() warning
options(dplyr.summarise.inform = FALSE)

# Melihat tren rata-rata produksi padi
rataproduksi <- padisumutfilter %>% 
  group_by(Tahun, Kabupaten_kota, .drop = FALSE) %>%  # Add .drop argument
  summarise(Rata_rata_produksi = sum(Rata_rata_produksi))
rataproduksi
```

```{r}

# Hitung total rata-rata produksi padi per Kabupaten/Kota
totrataproduksi_kabkota <- padisumutfilter %>% 
  group_by(Kabupaten_kota) %>% 
  summarise(total_rataproduksi = sum(Rata_rata_produksi))

# Visualisasi dengan barplot
plot_4 <- ggplot(totrataproduksi_kabkota, aes(x = Kabupaten_kota, y = total_rataproduksi, fill = Kabupaten_kota)) +
  geom_bar(stat = "identity") +
  labs(title = "Perbandingan Rata_rata Produksi Padi antara Kabupaten/Kota", x = "Kabupaten/Kota", y = "Rata_rata Produksi (Ton)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "none")  # hilangkan legend

# Rotasi sumbu x agar mudah dibaca
plot_4 + theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

### Korelasi Luas Panen dan Produksi Padi

```{r}
# Visualisasi korelasi luas panen dan produksi padi
plot_5 <- ggplot(padisumutfilter, aes(x = Luas_panen, y = Produksi, color = Kabupaten_kota)) +
  geom_point() +
  labs(title = "Korelasi Produksi dan Luas Panen", x = "Luas Panen (Ha)", y = "Produksi (Ton)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "right")
plot_5
```

```{r}
# Hitung Pearson correlation coefficient
correlation_padi <- cor(padisumutfilter$Luas_panen, padisumutfilter$Produksi)

# Nilai correlation coefficient
cat("Koefisien Korelasi Pearson Luas Panen dan Produksi:", correlation_padi)
```

Berdasarkan grafik diatas bisa lihat bahwa ada korelasi antara luas
panen dan produksi. Hubungan korelasi adalah positif dengan nilai
korelasi sebesar 0,99, sehingga bisa disimpulkan bahwa jika semakin
banyak luas panen maka akan meningkat jumlah produksi padi.

### Perbandingan Rata-rata produksi dengan Produksi Padi

```{r}
# Create a boxplot using ggplot2
plot_6 <- ggplot(padisumutfilter, aes(x = Kabupaten_kota, y = Produksi - Rata_rata_produksi, fill = Kabupaten_kota)) +
  geom_boxplot() +
  labs(title = "Perbandingan Produksi dan Rata-rata Produksi per Kabupaten/Kota", x = "Kabupaten/Kota", y = "Selisih Produksi") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "none")

# Rotasi sumbu x agar mudah dibaca
plot_6 + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Melihat pola musiman dalam data untuk produksi padi

```{r}
# Convert Tahun to Date format
padisumutfilter$Tahun <- as.Date(paste0(padisumutfilter$Tahun, "-01-01"))

# Create ACF plot
acf_plot <- acf(padisumutfilter$Produksi, main = "ACF Plot of Produksi Padi")

# Print ACF plot
print(acf_plot)

# Create periodogram
periodogram_plot <- spectrum(padisumutfilter$Produksi, main = "Periodogram of Produksi Padi")

# Print periodogram
periodogram_plot
```

Berdasarkan Periodogram Produksi Padi bisa dilihat bahwa ada fluktuasi
yang berulang dalam data sehingga bisa disimpulkan adanya pola musiman.
Melihat hal ini maka akan dilakukan analisis prediksi yang lebih lanjut
dan komplek.

## Model

### a. Clustering Produksi Padi

```{r}
# Filter data produksi terbanyak berdasarkan tahun
grouped_data <- padisumutfilter %>%
  group_by(Tahun) %>%
  arrange(desc(Produksi)) %>%
  summarise(Total_Produksi = sum(Produksi))
grouped_data
            
```

Berdasarkan hasil diatas bisa dilihat jumlah total produksi terbanyak
ada pada Tahun 2017, yaitu sebanyak 5136186 Ton

```{r}
# Menyiapkan data, untuk pengujian klastering data yang ambil adalah data tahun 2017 saja
datapadi2017 <- padisumutfilter %>% 
  filter(Tahun == "2017-01-01")
```

```{r}
# Memilih variabel klastering
clustering_data <- datapadi2017 %>% 
 select(Produksi, Rata_rata_produksi, Luas_panen)
```

```{r}
# Tentukan skala dari variabel
scale_data <- as.data.frame(scale(clustering_data))
```

```{r}
# Elbow method to find the optimal number of clusters
set.seed(123)
fviz_nbclust(scale_data, kmeans, method = "wss")
```

```{r}
# Silhouette method to find the optimal number of clusters
silhouette_scores <- sapply(2:10, function(k) {
  kmeans_result <- kmeans(scale_data, centers = k)
  mean_silhouette <- mean(silhouette(kmeans_result$cluster, dist(scale_data)))
  return(mean_silhouette)
})

# Plot silhouette scores
plot(2:10, silhouette_scores, type = "b", pch = 19, xlab = "Number of clusters", ylab = "Mean Silhouette Score")

# Find the optimal number of clusters based on the highest silhouette score
optimal_k <- which.max(silhouette_scores) + 1
cat("Optimal number of clusters:", optimal_k)
```

```{r}
# Klastering dengan K-Means
set.seed(123)
k <- 8 # jumlah klaster
kmeans_result <- kmeans(scale_data, centers = k)
```

```{r}
# tambahkan label ke dalam data frame
datapadi2017$Cluster <- as.factor(kmeans_result$cluster)
```

```{r}
# Create a scatter plot using ggplot2
plot_8 <- ggplot(datapadi2017, aes(x = Luas_panen, y = Produksi, color = factor(Cluster))) +
  geom_point() +
  labs(title = "Hasil Clustering Produksi Padi", x = "Luas Panen", y = "Produksi") +
  scale_color_discrete(name = "Cluster") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()
plot_8
```

```{r}
# Menghitung jumlah klaster per kabupaten/kota

cluster_counts_per_kabupaten <- datapadi2017 %>%
  group_by(Kabupaten_kota, Cluster) %>%
  count()

cluster_counts_per_kabupaten
```

```{r}
# Hitung jumlah kabupaten setiap klaster
cluster_kabupaten_counts <- datapadi2017 %>%
  filter(Cluster %in% c(1, 2, 3, 4, 5, 6, 7, 8)) %>%
  group_by(Cluster) %>%
  summarise(Jumlah_Kabupaten = n())

cluster_kabupaten_counts
```

```{r}
# Create a scatter plot using ggplot2
plot_9 <- ggplot(datapadi2017, aes(x = Luas_panen, y = Produksi, label = Kabupaten_kota)) +
  geom_point(aes(color = factor(Cluster))) +
  geom_text(vjust = -0.5, hjust = 0, size = 3, show.legend = FALSE) +
  labs(title = "Hasil Clustering Produksi Padi", x = "Luas Panen (Ha)", y = "Produksi (Ton)") +
  scale_color_discrete(name = "Cluster") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()
plot_9
```

```{r}
# Hitung rata-rata produksi per klaster
cluster_avg <- datapadi2017 %>%
  group_by(Cluster) %>%
  summarise(Avg_Produksi = mean(Produksi))

cluster_avg
```

```{r}
kmeans_result$centers
```

```{r}
# Definisikan kriteria klaster
low_criteria <- quantile(cluster_avg$Avg_Produksi, 0.25)
high_criteria <- quantile(cluster_avg$Avg_Produksi, 0.75)

# Berikan label untuk masing-masing klaster
cluster_avg_kriteria <- cluster_avg %>%
  mutate(Category = ifelse(Avg_Produksi < low_criteria, "Rendah",
                           ifelse(Avg_Produksi > high_criteria, "Tinggi", "Sedang")))
cluster_avg_kriteria
```

Berdasarkan hasil perhitungan nilai centroid dari klaster, maka bisa
disimpulkan bahwa: 1. Klaster 4 dan 8: adalah klaster yang termasuk
kategori rendah 2. Klaster 1,2,5 dan 6: adalah klaster yang termasuk
kategori sedang 3. Klaster 3 dan 7: adalah klaster yang termasuk
kategori tinggi

```{r}
# Menghitung jumlah klaster per kelompok kabupaten/kota
kabupaten_per_cluster <- datapadi2017 %>%
  group_by(Cluster) %>%
  summarise(Kabupaten_kota = list(unique(Kabupaten_kota)))

# Menampilkan nama kabupaten/kota dari setiap klaster
for (i in 1:8) {
  cat(paste("Klaster", i, ":", kabupaten_per_cluster$Kabupaten_kota[[i]], "\n"))
}
```

```{r}
# Evaluasi Clustering dengan Inertia

# Jumlah klaster yang diuji
k_values <- 2:8

# Hitung nilai Inertia untuk setiap klaster
inertia_values <- sapply(k_values, function(k) {
  kmeans_result <- kmeans(clustering_data, centers = k)
  kmeans_result$tot.withinss
})

inertia_df <- data.frame(K = k_values, Inertia = inertia_values)
inertia_df
```

Berdasarkan hasil evaluasi dengan Inertia, didapatkan bahwa jumlah
klaster yang tepat untuk pengujian klaster yang dilakukan adalah 8,
karena nilai Inertia yang paling rendah

```{r}
akurasi_klastering <- (kmeans_result$betweenss/kmeans_result$totss)*100
akurasi_klastering
```

Akurasi klaster bisa diketahui dengan menghitung rasio dari jumlah
kuadrat antar klaster dengan jumlah kuadrat total. Sehingga nilai
validitas dari model klastering adalah 93,85

```{r}
# Membaca dataset
data <- datapadi2017[, 3:5]

# Menentukan jumlah cluster yang diinginkan
num_clusters <- 10

# Membuat model GMM
gmm_model <- Mclust(data, G = num_clusters)

# Mendapatkan hasil klastering
cluster_assignment <- gmm_model$classification

# Menampilkan hasil klastering
cat("Cluster Assignment for Each Data Point:\n")
cluster_assignment

# Plot hasil klastering
plot(data, col = cluster_assignment, pch = 19, main = "GMM Clustering")

```

Pengujian Klaster dengan Kombinasi K-Means dan GMM

```{r}
# Memilih fitur untuk klaster
features <- datapadi2017[, c("Produksi", "Luas_panen", "Rata_rata_produksi")]

# Menstardisasi fitur
scaled_features <- scale(features)

# Klaster dengan K-Means
kmeans_result <- kmeans(scaled_features, centers = 8)

# Tentukan nilai Klaster
cluster_assignment <- kmeans_result$cluster

# Tambahkan nilai klaster ke data aktual
clustered_data <- cbind(datapadi2017, Cluster = cluster_assignment)

# Performansi GMM clustering untuk setiap klaster
gmm_clusters <- list()
for (cluster_id in unique(cluster_assignment)) {
  cluster_data <- scaled_features[cluster_assignment == cluster_id, ]
  gmm_result <- Mclust(cluster_data)
  gmm_clusters[[cluster_id]] <- gmm_result$classification
}

# Tampilkan hasil klaster
for (cluster_id in unique(cluster_assignment)) {
  cat("Cluster", cluster_id, ":", gmm_clusters[[cluster_id]], "\n")
}

# Kombinasi GMM cluster dengan Dataset aktual
final_clustered_data <- clustered_data
for (cluster_id in unique(cluster_assignment)) {
  final_clustered_data$GMM_Cluster[final_clustered_data$Cluster == cluster_id] <- gmm_clusters[[cluster_id]]
}

# Tampilkan hasil final klaster
final_clustered_data
```

```{r}
# Remove duplicate columns from the dataset
final_clustered_data <- final_clustered_data[, !duplicated(names(final_clustered_data))]

# Visualize the clustered data
ggplot(final_clustered_data, aes(x = Rata_rata_produksi, y = Luas_panen, color = factor(GMM_Cluster), label = Kabupaten_kota)) +
  geom_point() +
  geom_text(check_overlap = TRUE, vjust = -0.5) +  # Add district names
  xlab("Rata-rata Produksi (Ton)") +
  ylab("Luas Panen (Hektar)") +
  ggtitle("K-Means & GMM Clustering Rata-Rata Produksi Padi") +
  theme_minimal() +
  scale_color_discrete(name = "cluster")
```

```{r}
# Hitung Silhouette Score untuk melihat seberapa baik klaster yang dilakukan
silhouette_score <- silhouette(cluster_assignment, dist(scaled_features))
silhouette_score
```

Secara keseluruhan nilai Silhouette Score yang positif dan mendekati 1
menunjukkan bahwa klastering yang dilakukan memiliki hasil yang baik
dalam memisahkan objek-objek ke dalam kelompok-kelompok yang berbeda.

#### 2. Data Curah Hujan

### b. Regresi Liner

Tujuan dari analisis ini adalah unutk mencari tahu sejauh mana perubahan
dalam rata-rata produksi dan/atau luas panen dapat mempengaruhi
perubahan dalam jumlah produksi padi. Adapun hipotesis yang dapat
dikembangkan adalah: 1. Rata-rata produksi berpengaruh signifikan
terhadap jumlah produksi padi. 2. Luas panen berpengaruh signifikan
terhadap jumlah produksi padi. 3. Rata-rata produksi dan luas panen
berpengaruh signifikan terhadap jumlah produksi padi.

```{r}
# Load dataset padi
head(padisumutfilter)
```

```{r}
# Pilih variabel yang akan diukur pengaruh
datapadisumut <- padisumutfilter %>% 
  select(Rata_rata_produksi, Produksi, Luas_panen)
```

Model 1: Pengaruh rata-rata produksi terhadap jumlah produksi

```{r}
model_1 <- lm(Produksi ~ Rata_rata_produksi, data = datapadisumut)
summary(model_1)
```

```{r}
# Visualisasi hasil regresi model_1
ggplot(datapadisumut, aes(x = Rata_rata_produksi, y = Produksi)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(x = "Rata-rata Produksi", y = "Jumlah Produksi") +
  ggtitle("Hubungan Antara Rata-rata Produksi dan Jumlah Produksi") +
  theme_minimal()
```

Berdasarkan hasil di atas, kita dapat menyimpulkan bahwa rata-rata
produksi padi memiliki pengaruh yang signifikan terhadap jumlah
produksi. Nilai R-squared yang relatif rendah menunjukkan bahwa masih
ada variabilitas dalam jumlah produksi yang tidak dijelaskan oleh
rata-rata produksi, dan mungkin ada faktor lain yang juga mempengaruhi
hasil produksi padi.

Model 2: Pengaruh luas panen terhadap jumlah produksi

```{r}
model_2 <- lm(Produksi ~ Luas_panen, data = datapadisumut)
summary(model_2)
```

```{r}
# Visualisasi hasil regresi model_1
ggplot(datapadisumut, aes(x = Luas_panen, y = Produksi)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(x = "Luas Panen", y = "Jumlah Produksi") +
  ggtitle("Hubungan Antara Luas Panen dan Jumlah Produksi") +
  theme_minimal()
```

Berdasarkan hasil diatas, dapat disimpulkan bahwa luas panen memiliki
pengaruh yang signifikan terhadap produksi padi. Nilai R-squared yang
mendekati 1 (0.9861) menunjukkan bahwa model regresi ini mampu
menjelaskan sekitar 98.61% variasi dalam "Produksi" berdasarkan variabel
independen "Luas_panen".

Model 3: Pengaruh luas panen dan rata-rata produksi terhadap jumlah
produksi

```{r}
model_3 <- lm(Produksi ~ Luas_panen + Rata_rata_produksi, data = datapadisumut)
summary(model_3)
```

```{r}
# Visualisasi Model_3
ggplot(datapadisumut, aes(x = Produksi, y = predict(model_3))) +
  geom_point() +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  labs(title = "Produksi Padi vs. Prediksi Produksi Padi",
       x = "Observed Produksi",
       y = "Predicted Produksi")
```

Berdasarkan hasil diatas dapat disimpulkan bahwa kedua variabel
independen, yaitu "Luas_panen" dan "Rata_rata_produksi", memiliki
pengaruh yang signifikan terhadap "Produksi". Nilai R-squared yang
tinggi (0.988) menunjukkan bahwa model ini mampu menjelaskan sekitar
98.8% variasi dalam "Produksi" berdasarkan "Luas_panen" dan
"Rata_rata_produksi".

Model Klaster dan Regresi untuk Mengungkap Tren Produksi Padi

```{r}
# Siapkan data set. Dataset yangd digunakan adalah data padi 2017
set.seed(123)

# K-Means Clustering
k <- 8
kmeans_result <- kmeans(datapadi2017[, c("Produksi", "Luas_panen")], centers = k)
datapadi2017$Cluster <- kmeans_result$cluster

# Visualisasi Hasil Klaster
plot_11 <- ggplot(datapadi2017, aes(x = Luas_panen, y = Produksi, label = Kabupaten_kota)) +
  geom_point(aes(color = factor(Cluster))) +
  geom_text(vjust = -0.5, hjust = 0, size = 3, show.legend = FALSE) +
  labs(title = "Hasil Clustering Produksi Beras", x = "Luas Panen", y = "Produksi") +
  scale_color_discrete(name = "Cluster") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()

# Model Regresi Liner
lm_model <- lm(Produksi ~ Rata_rata_produksi + Luas_panen, data = datapadi2017)

# Tampilkan hasil model regresi
summary(lm_model)

# Visualisasi hasil regresi dan klaster produksi padi
plot_lm <- ggplot(datapadi2017, aes(x = Luas_panen, y = Produksi, label = Kabupaten_kota)) +
  geom_point(aes(color = factor(Cluster))) +
  geom_text(vjust = -0.5, hjust = 0, size = 3, show.legend = FALSE) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Hubungan Luas Panen dan Produksi", x = "Luas Panen (Ha)", y = "Produksi (Ton)") +
  scale_color_discrete(name = "Cluster") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()

# Tampilkan hasil visualisasi dari kedua model
plot_11
plot_lm

```

```{r}
akurasi_klastering2 <- (kmeans_result$betweenss/kmeans_result$totss)*100
akurasi_klastering2
```

### c. Model VAR

Tujuan adalah untuk mengidentifikasi apakah perubahan curah hujan dapat
mempengaruhi produksi padi. Akan melakukan prediksi curah hujan dan
produksi padi dimasa depan berdasarkan pola hubungan historis antara 2
variabel. Mengidentifikasi apakah perubahan dalam curah hujan dalam satu
periode dapat memiliki efek jangka pendek atau panjang terhadap produksi
padi.

```{r}
# Load data curah hujan
rainfall <- read.csv("dataset/climateserv-statistical.csv")
head(rainfall)
```

```{r}
# Merubah type variabel DateTime menjadi Date
rainfall$DateTime <- as.Date(rainfall$DateTime)
glimpse(rainfall)
```

```{r}
# Merubah nama variabel
names(rainfall)[names(rainfall) == "DateTime"] <- "date"
names(rainfall)[names(rainfall) == "UCSB.CHIRPS.Rainfall..avg"] <- "rainfallavg"
glimpse(rainfall)
```

```{r}
head(rainfall)
tail(rainfall)
```

```{r}
# Mengambil rata-rata curah hujan per tahun
rainfall_yearly <- rainfall %>%
  mutate(year = lubridate::year(date)) %>%
  group_by(year) %>%
  summarise(avg_rainfall = mean(rainfallavg))
rainfall_yearly  
```

```{r}
# Merubah type tahun menjadi date
rainfall_yearly$year <- make_date(rainfall_yearly$year)
rainfall_yearly
```

```{r}
# Filter data for "Sumatera Utara" kabupaten
sumut_data <- padi_sumut %>%
  filter(Kabupaten_kota == "Sumatera Utara")
sumut_data
```

```{r}
# Mengabungkan kedua dataset
merged_data <- merge(sumut_data, rainfall_yearly, by.x = "Tahun", by.y = "year")
merged_data
```

```{r}
# Pilih variabel yang akan diprediksi
# dalam pengujian ini akan dilihat apakah ada pengaruh curah hujan terhadap peningkatan produksi
data_for_var <- merged_data[, c("Rata_rata_produksi", "avg_rainfall")]
```

Untuk mendukung prediksi dengan Model VAR, data harus dirubah kedalam
format time series (ts)

```{r}
ts_data <- ts(data_for_var, start = c(2010,1), frequency = 1)
ts_data
```

```{r}
best_lag <- VARselect(ts_data, lag.max = 5, type = "both")
best_lag
```

```{r}
# VAR Model
var_model_1 <- VAR(ts_data, p = best_lag$selection[1], type = "both") # jumlah order dari model VAR
summary(var_model_1)
```

Kalau dilihat dari hasil model VAR diatas, maka bisa disimpulkan bahwa peningkatan jumlah rata-rata curah hujan menyebabkan penurunan rata-rata produksi padi. 
hal ini bisa diidentifikan bahwa Koefisien estimasi untuk "avg_rainfall.l1" adalah -0.7378, yang mengindikasikan bahwa peningkatan "avg_rainfall" pada satu periode sebelumnya (lag 1) akan menyebabkan penurunan sekitar 0.7378 pada "Rata_rata_produksi" saat ini. dilihat dari nilai F-statistic menguji signifikansi keseluruhan model. Nilai p-value dari F-statistic adalah 0.3383, yang lebih besar dari 0.05, sehingga model secara keseluruhan tidak signifikan secara statistik.

```{r}
# Melakukan uji Granger Causality
granger_test <- causality(var_model_1, cause = "avg_rainfall")
granger_test
```
Secara keseluruhan, berdasarkan hasil uji Granger Causality dan Instantaneous Causality, tidak ada bukti statistik yang kuat untuk mendukung adanya hubungan sebab-akibat antara "avg_rainfall" dan "Rata_rata_produksi" dalam model VAR, baik dalam jangka waktu lag maupun dalam jangka waktu instan.


```{r}
# Membuat model regresi linier
regression_model <- lm(Rata_rata_produksi ~ avg_rainfall, data = data_for_var)

# Ringkasan hasil model
summary(regression_model)
```

Dilihat dari model regresi juga kelihatan bahwa tidak ada pengaruh curah hujan terhadap produksi padi

```{r}
# Menghitung koefisien korelasi Pearson
correlation <- cor(data_for_var$Rata_rata_produksi, data_for_var$avg_rainfall)
correlation
```

Dilihat dari hubungan negatif, artinya tingginya curah hujan biasanya berhubungan dengan rata-rata produksi yang rendah.

### d. Prediksi Produksi Padi dengan ML

```{r}
# Menghitung total produksi untuk setiap tahun
summary_data <- padisumut_clean %>%
  group_by(Tahun) %>%
  summarise(total_produksi = sum(Produksi))
summary_data
```

```{r}
# Membuat bar chart atau line chart
ggplot(summary_data, aes(x = Tahun, y = total_produksi)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  labs(title = "Perubahan Jumlah Produksi Padi dari 2010 - 2020",
       x = "Tahun",
       y = "Total Produksi")
```

```{r}
# Ekplorasi Data
summary_data %>% 
  plot_time_series(.date_var = Tahun,
                   .value = total_produksi,
                   .line_size = 1,
                   .smooth_size = 0.5,
                   .smooth_alpha = 0.4,
                   .interactive = TRUE, 
                   .x_lab = "Tahun", 
                   .y_lab = "Jumlah Produksi Padi (Ton)", 
                   .title = "Hasil Produksi Padi di Sumatera Utara (2010-2020)")
```

```{r}
# Uji Augmented Dickey-Fuller (ADF) untuk stasioneritas
library(tseries)
data <-  summary_data$total_produksi
adf_test <- adf.test(data)
adf_test
```

```{r}
library(modeltime.resample)
resamples_tscv <- time_series_cv(
    data        = summary_data,
    assess      = "2 year",
    initial     = "7 years",
    skip        = "1 year",
    slice_limit = 3
)
```

```{r}
resamples_tscv %>%
    tk_time_series_cv_plan() %>%
    plot_time_series_cv_plan(.date_var = Tahun, 
                             .value = total_produksi, 
                             .interactive = TRUE)
```

1.  Model ARIMA

```{r}
library(parsnip)
model_fit_arima <- arima_reg() %>%
    set_engine(engine = "auto_arima") %>% 
    fit(formula = total_produksi ~ Tahun, 
        data = summary_data)

model_fit_arima 
```

2.  Model ETS

```{r}
model_fit_ets <- exp_smoothing() %>%
    set_engine(engine = "ets") %>% 
    fit(formula = total_produksi ~ Tahun, 
        data = summary_data)

model_fit_ets
```

3.  Model Prophet

```{r}
model_fit_prophet <- prophet_reg() %>%
    set_engine(engine = "prophet") %>%
    fit(formula = total_produksi ~ Tahun, 
        data = summary_data)

model_fit_prophet
```

```{r}
# Menggabungkan Model
models_tbl <- modeltime_table(model_fit_arima,
                              model_fit_prophet,
                              model_fit_ets)

models_tbl
```

4.  Pelatihan dan Evaluasi Model

```{r}
resamples_fitted <- models_tbl %>%
    modeltime_fit_resamples(resamples = resamples_tscv)

resamples_fitted
```

```{r}
# Evaluasi Model
resamples_fitted %>%
    modeltime_resample_accuracy() %>%
    table_modeltime_accuracy(.title = "Tabel Evaluasi", 
                             .interactive = FALSE)
```

```{r}
resamples_fitted %>%
    plot_modeltime_resamples(.interactive = TRUE)
```

```{r}
models_tbl %>% 
  modeltime_residuals(new_data = summary_data) %>% 
  modeltime_residuals_test()
```

```{r}
# Prediksi Masa Depan
refit_tbl <- resamples_fitted %>%
    modeltime_refit(data = summary_data)
```

```{r}
forecast <- refit_tbl %>%
    modeltime_forecast(h = "1 years", 
                       actual_data = summary_data) 

forecast 
```

```{r}
# Visualisasi Hasil Forecasting
forecast %>%
    plot_modeltime_forecast(.interactive = TRUE)
```

```{r}
# Cross Validation Model Prophet
# Membaca data dan mempersiapkan dataset
data <- summary_data %>% 
  rename(
    ds = "Tahun",
    y = "total_produksi"
  )
data
# Buat fungsi untuk menghitung metrik evaluasi yang dibutuhkan
compute_metrics <- function(actual, forecast) {
  mae <- mean(abs(actual - forecast))
  mape <- mean(abs((actual - forecast) / actual) * 100)
  mase <- mean(abs(actual - forecast) / mean(abs(diff(actual))))
  smape <- mean(200 * abs(forecast - actual) / (abs(forecast) + abs(actual)))
  rmse <- sqrt(mean((actual - forecast)^2))
  metrics <- c(mae, mape, mase, smape, rmse)
  return(metrics)
}

# Cross-validation dengan Prophet
set.seed(123)
num_folds <- 5
folds <- cut(1:nrow(data), breaks = num_folds, labels = FALSE)

prophet_metrics <- matrix(NA, num_folds, 5)  # Ganti 6 dengan jumlah metrik evaluasi
for (fold in 1:num_folds) {
  train_data <- data[folds != fold, ]
  test_data <- data[folds == fold, ]
  
  # Train Prophet model
  prophet_model <- prophet(train_data)
  
  # Prediksi dengan model
  future <- make_future_dataframe(prophet_model, periods = nrow(test_data))
  forecast <- predict(prophet_model, future)
  
  # Hitung metrik evaluasi
  prophet_metrics[fold, ] <- compute_metrics(test_data$y, forecast$yhat)
}

# Mengubah hasil metrik evaluasi menjadi persentase
prophet_metrics <- prophet_metrics / 100

# Hasil metrik evaluasi cross-validation untuk Prophet
colnames(prophet_metrics) <- c("MAE", "MAPE", "MASE", "SMAPE", "RMSE")
mean_metrics <- colMeans(prophet_metrics, na.rm = TRUE)
print("Cross-Validation Metrics for Prophet:")
hasil_validasi <- format(mean_metrics, scientific = FALSE)
hasil_validasi

```

```{r}
# Ubah metrik evaluasi menjadi Coefficient of Determination (R-squared)
compute_r_squared <- function(actual, forecast) {
  rsq <- 1 - sum((actual - forecast)^2) / sum((actual - mean(actual))^2)
  return(rsq)
}

# Uji beberapa transformasi data dan hitung kembali R-squared
# Contoh: menggunakan log transformasi
log_transformed_actual <- log(test_data$y)
log_transformed_forecast <- log(forecast$yhat)
new_rsq <- compute_r_squared(log_transformed_actual, log_transformed_forecast)
print(new_rsq)

```

## Interpretasi

Berdasarkan hasil tersebut bisa disimpulkan bahwa: 
a) Untuk melakukan evaluasi hasil kluster dalam penelitian ini menggunakan Percentage of Variance Explained, ini adalah salah satu metrik yang digunakan untuk mengevaluasi sejauh mana kluster yang dihasilkan oleh model dapat menjelaskan variasi dalam data. Berdasarkan hasil evaluasi terhadap model kluster yang sudah dilakukan didapatkan bahwa nilai validitas kluster dari model adalah 93,85, hal ini menunjukkan bahwa sekitar 93,85% dari variasi dalam data dijelaskan oleh variasi antara kluster yang dihasilkan oleh model dianggap cukup tinggi. 
b) Nilai R-Square yang tinggi yaitu sebesar 0,988 dalam model regresi menunjukkan bahwa model
dapat menjelaskan 98,8% variasi dalam produksi padi berdasarkan luas panen dan rata-rata produksi. c) Untuk mengukur kinerja dan keandalan model Prophet dalam memprediksi produksi padi secara lebih objektif, maka dalam penelitian akan dilakukan Cross Validation. Cross Validation dapat digunakan untuk menghindari Overfitting atau kesalahan saat melakukan prediksi dengan data pengujian atau data yang baru(7)(8). Berdasarkan Cross Validation yang sudah dilakukan didapatkan bahwa model Prophet memiliki performa yang bervariasi dalam memprediksi data, dengan beberapa metrik MAE: 22,108.09 dan SMAPE=0,3299022 yang lebih rendah, sementara metrik lain seperti MASE=0,1281631 mengidentifikasikan
performa yang baik. 
d) Melihat hasil dari tiga model prediksi memiliki nilai prediksi yang berbeda, maka langkah selanjutnya adalah perlu melakukan uji asumsi disamping melihat perbedaan nilai error dari evaluasi model yang sudah dilakukan sebelumnya. Berdasarkan hasil uji asumsi atas tiga model, dapat dijelaskan bahwa data berdistribusi normal, tidak ada autokorelasi atau korelasi serial dalam residu, sehingga ketiga model dapat digunakan dan cocok untuk memprediksi nilai produksi padi yang akan datang.

# 4. Data Jagung

## Obstain - Load Dataset Palawija

```{r}
palawija_sumut <- read_excel("dataset/dataset_palawija_Sumut_update.xlsx")
palawija_sumut
```

## Scrub Data Palawija

Proses Scrub yang akan dilakukan adalah merubah type data dan menghapus data yang tidak penting atau data yang kosng (not available). Berdasarkan data palawija_sumut dapat dilihat bahwa type data dari kolom Tahun adalah double, rata-rata produksi, produksi dan luas panen bertype karakter. Maka untuk mendukung proses analisis maka type data Tahun harus dirubah ke type Date, dan data yg bertype karakter dirubah kedalam type numeric.

```{r}
glimpse(palawija_sumut)
```

### a. Merubah type data

```{r}
# Merubah type data karakter menjadi numeric
palawija_sumut$`Rata-rata_produksi` <- as.numeric(palawija_sumut$`Rata-rata_produksi`)
palawija_sumut$Produksi <- as.numeric(palawija_sumut$Produksi)
palawija_sumut$Luas_Panen <- as.numeric(palawija_sumut$Luas_Panen)
palawija_sumut
```

```{r}
# Merubah type Tahun menjadi Date
palawija_sumut$Tahun <- make_date(palawija_sumut$Tahun)
glimpse(palawija_sumut)
```

```{r}
# Merubah nama variabel Rata-rata Produksi
names(palawija_sumut)[names(palawija_sumut) == "Rata-rata_produksi"] <- "Rata_rata_produksi"
glimpse(palawija_sumut)
```

### b. Menghapus Data Kosong

```{r}
# Menampikan variabel dengan baris kosong
colSums(is.na(palawija_sumut))
```

```{r}
# Menghapus data NA's
palawijasumut_clean <- na.omit(palawija_sumut)
summary(palawijasumut_clean)
```

```{r}
colSums(is.na(palawijasumut_clean))
glimpse(palawijasumut_clean)

```

```{r}
# Mengambil semua data kecuali data Kabupaten "Sumatera Utara"
palawijasumutfilter <- palawijasumut_clean[palawijasumut_clean$Kabupaten_Kota != "Sumatera Utara",]
palawijasumutfilter
```

```{r}
head(palawijasumutfilter)
```
```{r}
tail(palawijasumutfilter)
```



## Eksplorasi Data Analisis (EDA)

### Jumlah Produksi Jagung per Kabupaten/Kota

```{r}
plot_jagung_1 <- ggplot(palawijasumutfilter, aes(x = Tahun, y = Produksi, group = Kabupaten_Kota, color = Kabupaten_Kota)) +
  geom_point() +
  labs(title = "Jumlah Produksi Jagung", x = "Tahun", y = "Produksi Jagung (Ha)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "right")
plot_jagung_1

```

```{r}
# Hitung total produksi per kabupaten/kota
totproduksi_jagung <- palawijasumutfilter %>% 
  #mutate(first_date_month = floor_date(Tahun, unit = "year")) %>% 
  group_by(Kabupaten_Kota) %>% 
  summarise(jumlahproduksi = sum(Produksi)) %>% 
  arrange(jumlahproduksi)
totproduksi_jagung
```

```{r}
# Turn off dplyr summarise() warning
options(dplyr.summarise.inform = FALSE)

# Hitung total produksi per kabupaten/tahun
totproduksi_jagung <- palawijasumutfilter %>% 
  group_by(Tahun, Kabupaten_Kota, .drop = FALSE) %>%  # Add .drop argument
  summarise(total_produksi = sum(Produksi))

totproduksi_jagung
```

```{r}
summary(totproduksi_jagung)
```

### Tren Produksi Jagung per Kabupaten/Kota

```{r}
# Visualisasi Tren Produksi Jagung
plot_jagung_2 <- ggplot(totproduksi_jagung, aes(x = Tahun, y = total_produksi, color = Kabupaten_Kota)) +
  geom_line() +
  geom_point() +
  labs(title = "Tren Produksi Jagung", x = "Tahun", y = "Total Produksi (Ton)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "right")
plot_jagung_2
```

### Perbandingan Produksi Jagung per Kabupaten/Kota

```{r}
# Ambil data tanaman pangan Jagung
palawijasumut_jagung <- palawijasumutfilter[palawijasumutfilter$Nama_Palawija == "Jagung",]
```

```{r}
palawijasumut_jagung
```

```{r}
# Hitung total produksi Jagung per Kabupaten/Kota
totproduksi_jagung_kabkota <- palawijasumut_jagung %>% 
  group_by(Kabupaten_Kota) %>% 
  summarise(total_produksi = sum(Produksi))
totproduksi_jagung_kabkota

# Visualisasi dengan barplot
plot_jagung_3 <- ggplot(totproduksi_jagung_kabkota, aes(x = Kabupaten_Kota, y = total_produksi, fill = Kabupaten_Kota)) +
  geom_bar(stat = "identity") +
  labs(title = "Perbandingan Produksi Jagung antara Kabupaten/Kota", x = "Kabupaten/Kota", y = "Total Produksi (Ton)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "none")  # hilangkan legend

# Rotasi sumbu x agar mudah dibaca
plot_jagung_3 + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Perbandingan produksi Jagung dalam kurun waktu 2010 - 2022 adalah dari Kabupaten Karo yang terbanyak dengan Jumlah Produksi Jagung sebesar 11164760.42 Ton

### Perbandingan Rata-rata produksi Jagung per Kabupaten/Kota

```{r}
# Turn off dplyr summarise() warning
options(dplyr.summarise.inform = FALSE)

# Melihat tren rata-rata produksi padi
rataproduksi_jagung <- palawijasumut_jagung %>% 
  group_by(Tahun, Kabupaten_Kota, .drop = FALSE) %>%  # Add .drop argument
  summarise(Rata_rata_produksi = sum(Rata_rata_produksi))
rataproduksi_jagung
```

```{r}

# Hitung total rata-rata produksi Jagung per Kabupaten/Kota
totrataproduksi_jagung_kabkota <- palawijasumut_jagung %>% 
  group_by(Kabupaten_Kota) %>% 
  summarise(total_rataproduksi = sum(Rata_rata_produksi))

# Visualisasi dengan barplot
plot_jagung_4 <- ggplot(totrataproduksi_jagung_kabkota, aes(x = Kabupaten_Kota, y = total_rataproduksi, fill = Kabupaten_Kota)) +
  geom_bar(stat = "identity") +
  labs(title = "Perbandingan Rata_rata Produksi Jagung antara Kabupaten/Kota", x = "Kabupaten/Kota", y = "Rata_rata Produksi (Ton)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "none")  # hilangkan legend

# Rotasi sumbu x agar mudah dibaca
plot_jagung_4 + theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

### Korelasi Luas Panen dan Produksi Jagung

```{r}
# Visualisasi korelasi luas panen dan produksi Jagung
plot_jagung_5 <- ggplot(palawijasumut_jagung, aes(x = Luas_Panen, y = Produksi, color = Kabupaten_Kota)) +
  geom_point() +
  labs(title = "Korelasi Produksi dan Luas Panen", x = "Luas Panen (Ha)", y = "Produksi (Ton)") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "right")
plot_jagung_5
```

```{r}
# Hitung Pearson correlation coefficient
correlation_jagung <- cor(palawijasumut_jagung$Luas_Panen, palawijasumut_jagung$Produksi)

# Nilai correlation coefficient
cat("Koefisien Korelasi Pearson Luas Panen dan Produksi:", correlation_jagung)
```

Berdasarkan grafik diatas bisa lihat bahwa ada korelasi antara luas panen dan produksi. Hubungan korelasi adalah positif dengan nilai korelasi sebesar 0,62, sehingga bisa disimpulkan bahwa jika semakin banyak luas panen maka akan meningkat jumlah produksi jagung.

### Perbandingan Rata-rata produksi dengan Produksi Jagung

```{r}
# Create a boxplot using ggplot2
plot_jagung_6 <- ggplot(palawijasumut_jagung, aes(x = Kabupaten_Kota, y = Produksi - Rata_rata_produksi, fill = Kabupaten_Kota)) +
  geom_boxplot() +
  labs(title = "Perbandingan Produksi dan Rata-rata Produksi per Kabupaten/Kota", x = "Kabupaten/Kota", y = "Selisih Produksi") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "none")

# Rotasi sumbu x agar mudah dibaca
plot_jagung_6 + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Melihat pola musiman dalam data untuk produksi jagung

```{r}
# Convert Tahun to Date format
palawijasumut_jagung$tahun <- as.Date(paste0(palawijasumut_jagung$Tahun, "-01-01"))

# Create ACF plot
acf_plot <- acf(palawijasumut_jagung$Produksi, main = "ACF Plot of Produksi Jagung")

# Print ACF plot
print(acf_plot)

# Create periodogram
periodogram_plot_jagung <- spectrum(palawijasumut_jagung$Produksi, main = "Periodogram of Produksi Jagung")

# Print periodogram
periodogram_plot_jagung
```

## Model

### a. Clustering Produksi Jagung

```{r}
# Filter data produksi terbanyak berdasarkan tahun
grouped_data_jagung <- palawijasumut_jagung %>%
  group_by(Tahun) %>%
  arrange(desc(Produksi)) %>%
  summarise(Total_Produksi = sum(Produksi))
grouped_data_jagung
            
```

Berdasarkan hasil diatas bisa dilihat jumlah total produksi terbanyak ada pada Tahun 2013, yaitu sebanyak 5000925 Ton

```{r}
# Menyiapkan data, untuk pengujian klastering data yang ambil adalah data tahun 2013 saja
datajagung2013 <- palawijasumut_jagung %>% 
  filter(Tahun == "2013-01-01")
datajagung2013
```

```{r}
# Memilih variabel klastering
cluster_data_jagung <- datajagung2013 %>% 
  dplyr::select(Produksi, Rata_rata_produksi, Luas_Panen)

```

```{r}
# Tentukan skala dari variabel
scale_data <- as.data.frame(scale(cluster_data_jagung))
```

```{r}
# Elbow method to find the optimal number of clusters
set.seed(123)
fviz_nbclust(scale_data, kmeans, method = "wss")
```

```{r}
# Silhouette method to find the optimal number of clusters
silhouette_scores <- sapply(2:10, function(k) {
  kmeans_result <- kmeans(scale_data, centers = k)
  mean_silhouette <- mean(silhouette(kmeans_result$cluster, dist(scale_data)))
  return(mean_silhouette)
})

# Plot silhouette scores
plot(2:10, silhouette_scores, type = "b", pch = 19, xlab = "Number of clusters", ylab = "Mean Silhouette Score")

# Find the optimal number of clusters based on the highest silhouette score
optimal_k <- which.max(silhouette_scores) + 1
cat("Optimal number of clusters:", optimal_k)
```

```{r}
# Klastering dengan K-Means
set.seed(123)
k <- 8 # jumlah klaster
kmeans_result <- kmeans(scale_data, centers = k)
```

```{r}
# tambahkan label ke dalam data frame
datajagung2013$Cluster <- as.factor(kmeans_result$cluster)
```

```{r}
# Create a scatter plot using ggplot2
plot_jagung_8 <- ggplot(datajagung2013, aes(x = Luas_Panen, y = Produksi, color = factor(Cluster))) +
  geom_point() +
  labs(title = "Hasil Clustering Produksi Jagung", x = "Luas Panen", y = "Produksi") +
  scale_color_discrete(name = "Cluster") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()
plot_jagung_8
```

```{r}
# Menghitung jumlah klaster per kabupaten/kota

cluster_counts_per_kabupaten <- datajagung2013 %>%
  group_by(Kabupaten_Kota, Cluster) %>%
  count()

cluster_counts_per_kabupaten
```

```{r}
# Hitung jumlah kabupaten setiap klaster
cluster_kabupaten_counts <- datajagung2013 %>%
  filter(Cluster %in% c(1, 2, 3, 4, 5, 6, 7, 8)) %>%
  group_by(Cluster) %>%
  summarise(Jumlah_Kabupaten = n())

cluster_kabupaten_counts
```

```{r}
# Create a scatter plot using ggplot2
plot_jagung_9 <- ggplot(datajagung2013, aes(x = Luas_Panen, y = Produksi, label = Kabupaten_Kota)) +
  geom_point(aes(color = factor(Cluster))) +
  geom_text(vjust = -0.5, hjust = 0, size = 3, show.legend = FALSE) +
  labs(title = "Hasil Clustering Produksi Jagung", x = "Luas Panen (Ha)", y = "Produksi (Ton)") +
  scale_color_discrete(name = "Cluster") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()
plot_jagung_9
```

```{r}
# Hitung rata-rata produksi per klaster
cluster_avg <- datajagung2013 %>%
  group_by(Cluster) %>%
  summarise(Avg_Produksi = mean(Produksi))

cluster_avg
```

```{r}
kmeans_result$centers
```

```{r}
# Definisikan kriteria klaster
low_criteria <- quantile(cluster_avg$Avg_Produksi, 0.25)
high_criteria <- quantile(cluster_avg$Avg_Produksi, 0.75)

# Berikan label untuk masing-masing klaster
cluster_avg_kriteria <- cluster_avg %>%
  mutate(Category = ifelse(Avg_Produksi < low_criteria, "Rendah",
                           ifelse(Avg_Produksi > high_criteria, "Tinggi", "Sedang")))
cluster_avg_kriteria
```

Berdasarkan hasil perhitungan nilai centroid dari klaster, maka bisa disimpulkan bahwa: 
1. Klaster 2 dan 3: adalah klaster yang termasuk kategori rendah 
2. Klaster 1,4,5 dan 8: adalah klaster yang termasuk kategori sedang 
3. Klaster 6 dan 7: adalah klaster yang termasuk kategori tinggi

```{r}
# Menghitung jumlah klaster per kelompok kabupaten/kota
kabupaten_per_cluster <- datajagung2013 %>%
  group_by(Cluster) %>%
  summarise(Kabupaten_Kota = list(unique(Kabupaten_Kota)))

# Menampilkan nama kabupaten/kota dari setiap klaster
for (i in 1:8) {
  cat(paste("Klaster", i, ":", kabupaten_per_cluster$Kabupaten_Kota[[i]], "\n"))
}
```

```{r}
# Evaluasi Clustering dengan Inertia

# Jumlah klaster yang diuji
k_values <- 2:8

# Hitung nilai Inertia untuk setiap klaster
inertia_values <- sapply(k_values, function(k) {
  kmeans_result <- kmeans(cluster_data_jagung, centers = k)
  kmeans_result$tot.withinss
})

inertia_df <- data.frame(K = k_values, Inertia = inertia_values)
inertia_df
```

Berdasarkan hasil evaluasi dengan Inertia, didapatkan bahwa jumlah klaster yang tepat untuk pengujian klaster yang dilakukan adalah 8, karena nilai Inertia yang paling rendah

```{r}
akurasi_klastering_jagung <- (kmeans_result$betweenss/kmeans_result$totss)*100
akurasi_klastering_jagung
```

Akurasi klaster bisa diketahui dengan menghitung rasio dari jumlah kuadrat antar klaster dengan jumlah kuadrat total. Sehingga nilai validitas dari model klastering adalah 97,21

### b. Regresi Liner

Tujuan dari analisis ini adalah untuk mencari tahu sejauh mana perubahan dalam rata-rata produksi dan/atau luas panen dapat mempengaruhi perubahan dalam jumlah produksi jagung. Adapun hipotesis yang dapat dikembangkan adalah: 
1. Rata-rata produksi berpengaruh signifikan terhadap jumlah produksi jagung. 
2. Luas panen berpengaruh signifikan terhadap jumlah produksi jagung. 
3. Rata-rata produksi dan luas panen berpengaruh signifikan terhadap jumlah produksi jagung.

```{r}
# Load dataset padi
head(palawijasumut_jagung)

```

```{r}
# Pilih variabel yang akan diukur pengaruh
datajagungsumut <- palawijasumut_jagung %>% 
  dplyr::select(Rata_rata_produksi, Produksi, Luas_Panen)
```

Model 1: Pengaruh rata-rata produksi terhadap jumlah produksi

```{r}
model_1_jagung <- lm(Produksi ~ Rata_rata_produksi, data = datajagungsumut)
summary(model_1_jagung)
```

```{r}
# Visualisasi hasil regresi model_1
ggplot(datajagungsumut, aes(x = Rata_rata_produksi, y = Produksi)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(x = "Rata-rata Produksi", y = "Jumlah Produksi") +
  ggtitle("Hubungan Antara Rata-rata Produksi dan Jumlah Produksi") +
  theme_minimal()
```

Berdasarkan hasil di atas, kita dapat menyimpulkan bahwa rata-rata produksi jagung memiliki pengaruh yang signifikan terhadap jumlah produksi. Nilai R-squared yang relatif rendah menunjukkan bahwa masih ada variabilitas dalam jumlah produksi yang tidak dijelaskan oleh rata-rata produksi, dan mungkin ada faktor lain yang juga mempengaruhi hasil produksi padi.

Model 2: Pengaruh luas panen terhadap jumlah produksi

```{r}
model_2_jagung <- lm(Produksi ~ Luas_Panen, data = datajagungsumut)
summary(model_2_jagung)
```

```{r}
# Visualisasi hasil regresi model_2
ggplot(datajagungsumut, aes(x = Luas_Panen, y = Produksi)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(x = "Luas Panen", y = "Jumlah Produksi") +
  ggtitle("Hubungan Antara Luas Panen dan Jumlah Produksi") +
  theme_minimal()
```

Berdasarkan hasil diatas, dapat disimpulkan bahwa luas panen memiliki pengaruh yang signifikan terhadap produksi jagung. Nilai R-squared 0.3784 menunjukkan bahwa model regresi ini mampu menjelaskan sekitar 37.84% variasi dalam "Produksi" berdasarkan variabel independen "Luas_panen".

Model 3: Pengaruh luas panen dan rata-rata produksi terhadap jumlah produksi

```{r}
model_3_jagung <- lm(Produksi ~ Luas_Panen + Rata_rata_produksi, data = datajagungsumut)
summary(model_3_jagung)
```

```{r}
# Visualisasi Model_3
ggplot(datajagungsumut, aes(x = Produksi, y = predict(model_3_jagung))) +
  geom_point() +
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  labs(title = "Produksi Jagung vs. Prediksi Produksi Jagung",
       x = "Observed Produksi",
       y = "Predicted Produksi")
```

Berdasarkan hasil diatas dapat disimpulkan bahwa hanya 1 variabel independen, yaitu "Luas_panen", memiliki pengaruh yang signifikan terhadap "Produksi". Nilai R-squared 0.3784 menunjukkan bahwa model ini mampu menjelaskan sekitar 37.84% variasi dalam "Produksi" berdasarkan "Luas_panen", artinya ada 62,16% lagi dipengaruhi oleh variasi variabel lain

Model Klaster dan Regresi untuk Mengungkap Tren Produksi Jagung

```{r}
# Siapkan data set. Dataset yangd digunakan adalah data jagung 2013
set.seed(123)

# K-Means Clustering
k <- 8
kmeans_result_jagung <- kmeans(datajagung2013[, c("Produksi", "Luas_Panen")], centers = k)
datajagung2013$Cluster <- kmeans_result_jagung$cluster

# Visualisasi Hasil Klaster
plot_11_jagung <- ggplot(datajagung2013, aes(x = Luas_Panen, y = Produksi, label = Kabupaten_Kota)) +
  geom_point(aes(color = factor(Cluster))) +
  geom_text(vjust = -0.5, hjust = 0, size = 3, show.legend = FALSE) +
  labs(title = "Hasil Clustering Produksi Jagung", x = "Luas Panen", y = "Produksi") +
  scale_color_discrete(name = "Cluster") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()

# Model Regresi Liner
lm_model_jagung <- lm(Produksi ~ Rata_rata_produksi + Luas_Panen, data = datajagung2013)

# Tampilkan hasil model regresi
summary(lm_model_jagung)

# Visualisasi hasil regresi dan klaster produksi padi
plot_lm_jagung <- ggplot(datajagung2013, aes(x = Luas_Panen, y = Produksi, label = Kabupaten_Kota)) +
  geom_point(aes(color = factor(Cluster))) +
  geom_text(vjust = -0.5, hjust = 0, size = 3, show.legend = FALSE) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Hubungan Luas Panen dan Produksi", x = "Luas Panen (Ha)", y = "Produksi (Ton)") +
  scale_color_discrete(name = "Cluster") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()

# Tampilkan hasil visualisasi dari kedua model
plot_11_jagung
plot_lm_jagung

```

```{r}
akurasi_klastering2_jagung <- (kmeans_result_jagung$betweenss/kmeans_result_jagung$totss)*100
akurasi_klastering2_jagung
```

Bisa dilihat bahwa tren produksi jagung tidak liner, luas panen tidak terlalu mempengaruhi jumlah produksi. Pengaruh luas panen terhadap produksi berkisar 58.84%. Sementara rata-rata produksi tidak berpengaruh terhadap produksi padi. Tidak tingginya pengaruh luas panen terhadap produksi bisa dipengaruhi oleh faktor-faktor lain yang akan dianalisis  lebih lanjut.

### c. Prediksi Produksi Jagung dengan ML

```{r}
# Menghitung total produksi untuk setiap tahun
summary_data_jagung <- palawijasumut_jagung %>%
  group_by(Tahun) %>%
  summarise(total_produksi = sum(Produksi))
summary_data_jagung
```

```{r}
# Membuat bar chart atau line chart
ggplot(summary_data_jagung, aes(x = Tahun, y = total_produksi)) +
  geom_line() +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  labs(title = "Perubahan Jumlah Produksi Jagung dari 2010 - 2022",
       x = "Tahun",
       y = "Total Produksi")
```

```{r}
# Ekplorasi Data
summary_data_jagung %>% 
  plot_time_series(.date_var = Tahun,
                   .value = total_produksi,
                   .line_size = 1,
                   .smooth_size = 0.5,
                   .smooth_alpha = 0.4,
                   .interactive = TRUE, 
                   .x_lab = "Tahun", 
                   .y_lab = "Jumlah Produksi Jagung (Ton)", 
                   .title = "Hasil Produksi Jagung di Sumatera Utara (2010-2022)")
```

```{r}
# Uji Augmented Dickey-Fuller (ADF) untuk stasioneritas
library(tseries)
data <-  summary_data_jagung$total_produksi
adf_test <- adf.test(data)
adf_test

```

```{r}
library(modeltime.resample)
resamples_tscv_jagung <- time_series_cv(
    data        = summary_data_jagung,
    assess      = "2 year",
    initial     = "8 years",
    skip        = "1 years",
    slice_limit = 4
) 
```

```{r}
resamples_tscv_jagung %>%
    tk_time_series_cv_plan() %>%
    plot_time_series_cv_plan(.date_var = Tahun, 
                             .value = total_produksi, 
                             .interactive = TRUE)
```

1.  Model ARIMA

```{r}
library(parsnip)
model_fit_arima_jagung <- arima_reg() %>%
    set_engine(engine = "auto_arima") %>% 
    fit(formula = total_produksi ~ Tahun, 
        data = summary_data_jagung)

model_fit_arima_jagung 
```

2.  Model ETS

```{r}
model_fit_ets_jagung <- exp_smoothing() %>%
    set_engine(engine = "ets") %>% 
    fit(formula = total_produksi ~ Tahun, 
        data = summary_data_jagung)

model_fit_ets_jagung
```

3.  Model Prophet

```{r}
model_fit_prophet_jagung <- prophet_reg() %>%
    set_engine(engine = "prophet") %>%
    fit(formula = total_produksi ~ Tahun, 
        data = summary_data_jagung)

model_fit_prophet_jagung
```

```{r}
# Menggabungkan Model
models_tbl_jagung <- modeltime_table(model_fit_arima_jagung,
                              model_fit_prophet_jagung,
                              model_fit_ets_jagung)

models_tbl_jagung
```

4.  Pelatihan dan Evaluasi Model

```{r}
resamples_fitted_jagung <- models_tbl_jagung %>%
    modeltime_fit_resamples(resamples = resamples_tscv_jagung)

resamples_fitted_jagung
```

```{r}
# Evaluasi Model
resamples_fitted_jagung %>%
    modeltime_resample_accuracy() %>%
    table_modeltime_accuracy(.title = "Tabel Evaluasi", 
                             .interactive = FALSE)
```

```{r}
resamples_fitted_jagung %>%
    plot_modeltime_resamples(.interactive = TRUE)
```

```{r}
models_tbl_jagung %>% 
  modeltime_residuals(new_data = summary_data_jagung) %>% 
  modeltime_residuals_test()
```

```{r}
# Prediksi Masa Depan
refit_tbl_jagung <- resamples_fitted_jagung %>%
    modeltime_refit(data = summary_data_jagung)
```

```{r}
forecast_jagung <- refit_tbl_jagung %>%
    modeltime_forecast(h = "1 years", 
                       actual_data = summary_data_jagung) 

forecast_jagung 
```

```{r}
# Visualisasi Hasil Forecasting
forecast_jagung %>%
    plot_modeltime_forecast(.interactive = TRUE)
```

```{r}
# Cross Validation Model Prophet
# Membaca data dan mempersiapkan dataset
data_jagung <- summary_data_jagung %>% 
  rename(
    ds = "Tahun",
    y = "total_produksi"
  )
data_jagung

# Buat fungsi untuk menghitung metrik evaluasi yang dibutuhkan
compute_metrics_jagung <- function(actual, forecast_jagung) {
  mae <- mean(abs(actual - forecast_jagung))
  mape <- mean(abs((actual - forecast_jagung) / actual) * 100)
  mase <- mean(abs(actual - forecast_jagung) / mean(abs(diff(actual))))
  smape <- mean(200 * abs(forecast_jagung - actual) / (abs(forecast_jagung) + abs(actual)))
  rmse <- sqrt(mean((actual - forecast_jagung)^2))
  metrics <- c(mae, mape, mase, smape, rmse)
  return(metrics)
}

# Cross-validation dengan Prophet
set.seed(123)
num_folds <- 5
folds <- cut(1:nrow(data_jagung), breaks = num_folds, labels = FALSE)

prophet_metrics_jagung <- matrix(NA, num_folds, 5)  # Ganti 6 dengan jumlah metrik evaluasi
for (fold in 1:num_folds) {
  train_data_jagung <- data_jagung[folds != fold, ]
  test_data_jagung <- data_jagung[folds == fold, ]
  
  # Train Prophet model
  prophet_model_jagung <- prophet(train_data_jagung)
  
  # Prediksi dengan model
  future_jagung <- make_future_dataframe(prophet_model_jagung, periods = nrow(test_data_jagung))
  forecast_jagung <- predict(prophet_model_jagung, future_jagung)
  
  # Hitung metrik evaluasi
  prophet_metrics_jagung[fold, ] <- compute_metrics_jagung(test_data_jagung$y, forecast_jagung$yhat)
}

# Mengubah hasil metrik evaluasi menjadi persentase
prophet_metrics_jagung <- prophet_metrics_jagung / 100

# Hasil metrik evaluasi cross-validation untuk Prophet
colnames(prophet_metrics_jagung) <- c("MAE", "MAPE", "MASE", "SMAPE", "RMSE")
mean_metrics <- colMeans(prophet_metrics_jagung, na.rm = TRUE)
print("Cross-Validation Metrics for Prophet:")
hasil_validasi_jagung <- format(mean_metrics, scientific = FALSE)
hasil_validasi_jagung

```

# 5. Data Kacang Hijau


# 6. Data Kacang Kedelai

# 7. Data Kacang Tanah

# 8. Data Ubi Jalar

# 9. Data Ubi Kayu
