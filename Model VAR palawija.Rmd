---
title: "Untitled"
author: "Fitria"
date: "2023-12-17"
output: html_document
---

```{r}
library(dplyr)
library(ggplot2)
library(lubridate)
library(summarytools)
library(readxl)
library(cluster)
library(scales)
library(vars)
library(rugarch)
library(caTools)
library(fGarch)
library(tseries)
library(tidyverse)
library(Metrics)
library(caret)
library(tsutils) # for time series manipulation and decomposition
library(forecast) # for GARCH model implementation
library(stats) # for statistical tests
```

#1. Kacang Hijau
```{r}
# Pilih variabel yang akan diprediksi
kacang_hijau <- Sumatera_kacang_hijau[, c("Produksi", "avg_rainfall", "Produktivitas")]
kacang_hijau
```

```{r}
# membagi data berdasarkan variabel avg_rainfall
set.seed(123)
train_data_INDEX <- createDataPartition(kacang_hijau$avg_rainfall, p=0.8, list = FALSE)
train_data_kh <- kacang_hijau[train_data_INDEX,] #pelatih
train_data_kh
test_data_kh <- kacang_hijau[-train_data_INDEX,] #penguji
test_data_kh
```

Untuk mendukung prediksi dengan Model VAR, data harus dirubah kedalam format time series (ts)
```{r}
ts_train_kh <-ts(train_data_kh, start = c(1993, 1), frequency = 1 )
ts_train_kh
```

```{r}
ts_test_kh <-ts(test_data_kh, start = c(1993, 1), frequency = 1 )
ts_test_kh
```

```{r}
# Menentukan lag terbaik
best_lag_kh <- VARselect(ts_train_kh, lag.max = 5, type = "both")
best_lag_kh
```

```{r}
# Membuat model VAR 
var_model_kh_Sumatera <- VAR(ts_train_kh, p = best_lag_kh$selection[1], type = "both")
summary(var_model_kh_Sumatera)
```
*kesimpulan*

Curah hujan tidak berdampak terhadap produksi dan produktivitas kacang hijau

```{r}
# Hitung FEVD
fevd_result_kh <- fevd(var_model_kh_Sumatera)

# Plot FEVD untuk setiap variabel
plot(fevd_result_kh)
```
## Uji Kolersi Pearson Kacang Hijau

```{r}
# Misalnya, uji korelasi antara Produksi dan avg_rainfall
kolerasi_kh_Sumatera1<-cor(test_data_kh$Produksi, test_data_kh$avg_rainfall, method = "pearson")
cat ("Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi:",kolerasi_kh_Sumatera1)

```
Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi: -0.10

```{r}
# Menghitung koefisien korelasi Pearson
kolerasi_kh_Sumatera2 <- cor(test_data_kh$avg_rainfall, test_data_kh $Produktivitas)
cat ("Koefisien Korelasi Pearson Rata-rata curah hujan dan Produktivitas:", kolerasi_kh_Sumatera2)
```
Koefisien Korelasi Pearson Rata-rata curah hujan dan Produktivitas: 0.33

## Uji Granger Causality Kacang kh
```{r}
# Melakukan uji Granger Causality 
granger_kh_Sumatera1 <- causality(var_model_kh_Sumatera, cause = "avg_rainfall")
granger_kh_Sumatera1

```
Granger= p-value = 0.9545 dan  instant = p-value = 1.658e-05

*kesimpulan*
Berdasarkan hasil uji Granger Causality, tidak terdapat bukti yang cukup untuk menyatakan bahwa avg_rainfall secara signifikan menyebabkan Granger, tetapi uji instant karena p-value lebih kecil dari 0.05


## Uji regresi linier kh
```{r}
# Mengambil residual dari model VAR
residuals_var_model <- resid(var_model_kh_Sumatera)

# Membuat model regresi linier menggunakan residual
regresi_kh_produktivitas <- lm(Produktivitas ~ avg_rainfall, data = as.data.frame(residuals_var_model))

# Ringkasan hasil model
summary(regresi_kh_produktivitas)

```
*Kesimpulan*
Terdapat bukti yang cukup (p-value 0.00105 ** ) bahwa curah hujan (avg_rainfall)  memiliki dampak pada Produktivitas. 

```{r}
# Mengambil residual dari model VAR
residuals_var_model2 <- resid(var_model_kh_Sumatera)

# Membuat model regresi linier menggunakan residual
regresi_kh_produksi <- lm(Produksi ~ avg_rainfall, data = as.data.frame(residuals_var_model))

# Ringkasan hasil model
summary(regresi_kh_produksi)

```

*Kesimpulan*
avg_rainfall) memiliki dampak yang signifikan pada Produks dengan p-value 0.000202 ***

## Interpretasi kacang kh
Berdasarkan hasil analisis dengan model VAR, analisis kausalitas, dan regresi linear ini, kita dapat menyimpulkan bahwa avg_rainfall tidak mempergaruhi produksi dan produktivitas Kacang kh di Sumatera.

# Prediksi Model VAR
```{r}
# Melakukan prediksi pada data testing
predictions_kacang_hijau <- predict(var_model_kh_Sumatera, n.ahead = nrow(test_data_kh))
predictions_kacang_hijau
```

```{r}
# Mengambil hanya kolom "fcst" dari setiap variabel
results_fcst_kh <- lapply(predictions_kacang_hijau$fcst, function(x) x[, "fcst"])
# Menampilkan hasil
print(results_fcst_kh)
```

### Evaluasi model rainfall
```{r}
prediksi_avgrainfal <- results_fcst$avg_rainfall
prediksi_avgrainfal
```

```{r}
actual_values_kacang_hijau <- test_data_kh$avg_rainfall
actual_values_kacang_hijau
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
mape_kh <- mean(abs((actual_values_kacang_hijau - prediksi_avgrainfal) / actual_values_kacang_hijau)) * 100
rmse_kh <- sqrt(mean((actual_values_kacang_hijau - prediksi_avgrainfal)^2))
mae_kh <- mean(abs(actual_values_kacang_hijau - prediksi_avgrainfal))
mse_kh <- mean((actual_values_kacang_hijau - prediksi_avgrainfal)^2)
```

```{r}
cat("MAPE_kh:", mape_kh, "\n")
cat("RMSE_kh:", rmse_kh, "\n")
cat("MAE_kh:", mae_kh, "\n")
cat("MSE_kh:", mse_kh, "\n")
```
MAPE_kh: 12.82279 
RMSE_kh: 1.175837 
MAE_kh: 0.8957413 
MSE_kh: 1.382592


### Evaluasi model Produksi
```{r}
actual_produksi_kh <- test_data_kh$Produksi
```

```{r}
predicted_produksi_kh <- results_fcst$Produksi
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
epsilon <- 1e-10  # Nilai kecil untuk menghindari pembagian dengan nol
mape_kh_pro <- mean(abs((actual_produksi_kh - predicted_produksi_kh) / pmax(actual_produksi_kh, epsilon))) * 100
rmse_kh_pro <- sqrt(mean((actual_produksi_kh- predicted_produksi_kh)^2))
mae_kh_pro <- mean(abs(actual_produksi_kh - predicted_produksi_kh))
mse_kh_pro <- mean((actual_produksi_kh - predicted_produksi_kh)^2)

cat("MAPE_kh:", mape_kh_pro, "\n")
cat("RMSE_kh:", rmse_kh_pro, "\n")
cat("MAE_kh:", mae_kh_pro, "\n")
cat("MSE_kh:", mse_kh_pro, "\n")
```
MAPE_kh: 7.984064e+13 
RMSE_kh: 2763.499 
MAE_kh: 2433.327 
MSE_kh: 7636929 

### Evaluasi model Produktivitas
```{r}
actual_produktivitas_kh <- test_data_kh$Produktivitas
```

```{r}
predicted_produktivitas_kh <- results_fcst$Produktivitas
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
epsilon <- 1e-10  # Nilai kecil untuk menghindari pembagian dengan nol
mape_kh_pt <- mean(abs((actual_produktivitas_kh - predicted_produktivitas_kh) / pmax(actual_produktivitas_kh, epsilon))) * 100
rmse_kh_pt <- sqrt(mean((actual_produktivitas_kh- predicted_produktivitas_kh)^2))
mae_kh_pt <- mean(abs(actual_produktivitas_kh - predicted_produktivitas_kh))
mse_kh_pt <- mean((actual_produktivitas_kh - predicted_produktivitas_kh)^2)

cat("MAPE_kh:", mape_kh_pt, "\n")
cat("RMSE_kh:", rmse_kh_pt, "\n")
cat("MAE_kh:", mae_kh_pt, "\n")
cat("MSE_kh:", mse_kh_pt, "\n")
```
MAPE_kh: 269945063492 
RMSE_kh: 2.598267 
MAE_kh: 1.468158 
MSE_kh: 6.750992 

#2. jagung
```{r}
# Pilih variabel yang akan diprediksi
data_var_jagung <- Sumatera_jagung[, c("Produksi", "avg_rainfall", "Produktivitas")]
data_var_jagung
```

```{r}
# membagi data berdasarkan variabel avg_rainfall
set.seed(123)
train_index_js <- createDataPartition(data_var_jagung$avg_rainfall, p=0.8, list = FALSE)
train_data_js <- data_var_jagung[train_index_js,] #pelatih
train_data_js
test_data_js <- data_var_jagung[-train_index_js,] #penguji
test_data_js
```

Untuk mendukung prediksi dengan Model VAR, data harus dirubah kedalam format time series (ts)
```{r}
ts_train_js <-ts(train_data_js, start = c(1993, 1), frequency = 1 )
ts_train_js
```

```{r}
ts_test_js <-ts(test_data_js, start = c(1993, 1), frequency = 1 )
ts_test_js
```

```{r}
#Menetukan lag terbaik
best_lag_js<- VARselect(ts_train_js, lag.max = 5, type = "both")
best_lag_js
```

### VAR Model terhadap jagung Sumatera
```{r}

var_model_js <- VAR(ts_train_js, p = best_lag_js$selection[1], type = "both") # jumlah order dari model VAR
summary(var_model_js)
```
Estimation results for equation Produksi: 
avg_rainfall.l1  -3.704e+04  1.595e+04  -2.322   0.0384 *
p-value: < 2.2e-16 

curah hujan hanya berdampak terhadap produksi

```{r}
# Hitung FEVD
fevd_result_js <- fevd(var_model_js)

# Plot FEVD untuk setiap variabel
plot(fevd_result_js)
```

### Uji Kolersi Pearson Jagung
```{r}
# Menghitung koefisien korelasi Pearson
kolerasi_js1 <- cor(test_data_js$Produksi, test_data_js$avg_rainfall)
cat ("Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi:",kolerasi_js1)
```
Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi: 0.13

```{r}
# Menghitung koefisien korelasi Pearson
kolerasi_js2 <- cor(test_data_js$avg_rainfall, test_data_js$Produktivitas)
cat ("Koefisien Korelasi Pearson Rata-rata curah hujan dan Produksi:", kolerasi_js2)
```
Koefisien Korelasi Pearson Rata-rata curah hujan dan Produksi: 0.08

### Uji Granger Causality Jagung
```{r}
# Melakukan uji Granger Causality 
granger_js1 <- causality(var_model_js, cause = "avg_rainfall")
granger_js1

#Uji Granger Causality digunakan untuk menguji apakah suatu variabel dapat digunakan untuk memprediksi variabel lain dalam model VAR
```
Granger :p-value = 0.07
Instant : p-value = 0.05
berdarkan p-value Uji Grager dan instast Jadi dapat disimpulkan bahwa terdapat bukti statisktik bahwa curah hujan memiilki hubungan sebab akibat secara instan dengan Produktivitas dan produksi


### Uji regresi linier jagung
```{r}
# Mengambil residual dari model VAR
residuals_js <- resid(var_model_js)

# Membuat model regresi linier
regresi_produksi_jagung <- lm(Produksi ~ avg_rainfall , data =as.data.frame(residuals_js))

# Ringkasan hasil model
summary(regresi_produksi_jagung)
```
Hasil:
avg_rainfall p=value 0.0583
Dapat disimpulkan bahwa Rata-rata curah hujan  mempergaruhi produksi jagung.

```{r}
# Membuat model regresi linier
regresi_produktivitas_jagung<- lm(Produktivitas ~ avg_rainfall, data = as.data.frame(residuals_js))

# Ringkasan hasil model
summary(regresi_produktivitas_jagung)
```
berdasarkan p-value curah hujan berdampak terhadap produktivitas

## Interpretasi Jagung 
Berdasarkan hasil analisis dengan model VAR, analisis kausalitas, dan regresi linear ini, kita dapat menyimpulkan bahwa:

1. Dalam model VAR, bahwa variabel avg_rainfall berdampak pada Produksi karena P-Value lebih besar dari 0,05  

2. Berdasarkan hasil uji Granger Causality dan Instantaneous Causality, ada bukti statistik yang kuat untuk mendukung adanya hubungan sebab-akibat antara "avg_rainfall" dan "Produktivitas" dalam model VAR dalam instan

3. Berdasarkan hasil analisis regresi didapatkan bahwa variabel "avg_rainfall"memiliki pengaruh yang terhadap variabel produksi dan produktivitas

4 jadi avg_rainfal berdampak terhadap produksi tetapi tidak berdampak terhadap produktivitas jagung.

### Prediksi Jagung dengan Model VAR
```{r}
# Melakukan prediksi pada data testing
predictions_jagung_var <- predict(var_model_js, n.ahead = nrow(test_data_js))
predictions_jagung_var
```

```{r}
# Mengambil hanya kolom "fcst" dari setiap variabel
results_fcst_jagung <- lapply(predictions_jagung_var$fcst, function(x) x[, "fcst"])
# Menampilkan hasil
print(results_fcst_jagung)
```

### Evaluasi model Produksi
```{r}
actual_produksi_jagung <- test_data_js$Produksi
```

```{r}
predicted_produksi_jagung <- results_fcst_jagung$Produksi
```

```{r}
#cek length
length(actual_produksi_jagung)
length(predicted_produksi_jagung)
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
epsilon <- 1e-10  # Nilai kecil untuk menghindari pembagian dengan nol
mape_jagung_pro <- mean(abs((actual_produksi_jagung-predicted_produksi_jagung)/pmax(actual_produksi_jagung, epsilon)))*100
rmse_jagung_pro <- sqrt(mean((actual_produksi_jagung-predicted_produksi_jagung)^2))
mae_jagung_pro <- mean(abs(actual_produksi_jagung-predicted_produksi_jagung))
mse_jagung_pro <- mean((actual_produksi_jagung-predicted_produksi_jagung)^2)

cat("MAPE_jagung:", mape_jagung_pro, "\n")
cat("RMSE_jagung:", rmse_jagung_pro, "\n")
cat("MAE_jagung:", mae_jagung_pro, "\n")
cat("MSE_jagung:", mse_jagung_pro, "\n")
```

MAPE_jagung: 27927.01 
RMSE_jagung: 883043.3 
MAE_jagung: 816326.5 
MSE_jagung: 779765473512


### Evaluasi model Produktivitas
```{r}
actual_produktivitas_jagung <- test_data_js$Produktivitas
```

```{r}
predicted_produktivitas_jagung <- results_fcst_jagung$Produktivitas
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
epsilon <- 1e-10  # Nilai kecil untuk menghindari pembagian dengan nol
mape_jagung_pt <- mean(abs((actual_produktivitas_jagung - predicted_produktivitas_jagung) / pmax(actual_produktivitas_jagung, epsilon))) * 100
rmse_jagung_pt <- sqrt(mean((actual_produktivitas_jagung- predicted_produktivitas_jagung)^2))
mae_jagung_pt <- mean(abs(actual_produktivitas_jagung - predicted_produktivitas_jagung))
mse_jagung_pt <- mean((actual_produktivitas_jagung - predicted_produktivitas_jagung)^2)

cat("MAPE_jagung:", mape_jagung_pt, "\n")
cat("RMSE_jagung:", rmse_jagung_pt, "\n")
cat("MAE_jagung:", mae_jagung_pt, "\n")
cat("MSE_jagung:", mse_jagung_pt, "\n")
```

MAPE_jagung: 57.38087 
RMSE_jagung: 18.67092 
MAE_jagung: 16.78609 
MSE_jagung: 348.6033 

# 3.VAR terhadap Kacang Kedelai Sumatera

```{r}
# Pilih variabel yang akan diprediksi

data_kk_Sumatera <- Sumatera_Kedelai[, c("Produksi", "avg_rainfall", "Produktivitas")]
data_kk_Sumatera
```

```{r}
# membagi data berdasarkan variabel avg_rainfall
set.seed(123)
train_index_kk <- createDataPartition(data_kk_Sumatera$avg_rainfall, p=0.8, list = FALSE)
train_data_kk <- data_kk_Sumatera[train_index_kk,] #pelatih
train_data_kk
test_data_kk <- data_kk_Sumatera[-train_index_kk,] #penguji
test_data_kk
```

Untuk mendukung prediksi dengan Model VAR, data harus dirubah kedalam format time series (ts)
```{r}
ts_train_kk <-ts(train_data_kk, start = c(1993, 1), frequency = 1 )
ts_train_kk
```

```{r}
ts_test_kk <-ts(test_data_kk, start = c(1993, 1), frequency = 1 )
ts_test_kk
```

```{r}
# Menentukan lag terbaik
best_lag_kk <- VARselect(ts_train_kk, lag.max = 5, type = "both")
best_lag_kk
```

### VAR Model terhadap produksi Kacang Kedelai Sumatera
```{r}
var_model_kk <- VAR(ts_train_kk, p = best_lag_kk$selection[1], type = "both") # jumlah order dari model VAR
summary(var_model_kk)
```

Berdasarkan hasil Model VAR Porduksi dan produktivitas tidak di pengaruhi oleh avg_rainfall

```{r}
# Hitung FEVD
fevd_result_kk <- fevd(var_model_kk)

# Plot FEVD untuk setiap variabel
plot(fevd_result_kk)
```

### Uji Kolersi Pearson Kacang Kedelai
```{r}
# Menghitung koefisien korelasi Pearson
kolerasi_kedelai_Sumatera1 <- cor(test_data_kk$Produksi, test_data_kk$avg_rainfall, method = "pearson")
cat ("Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi:",kolerasi_kedelai_Sumatera1)
```
Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi: -0.15

```{r}
# Menghitung koefisien korelasi Pearson
kolerasi_kedelai_Sumatera2 <- cor(test_data_kk$avg_rainfall, test_data_kk$Produktivitas, method = "pearson")
cat ("Koefisien Korelasi Pearson Rata-rata curah hujan dan Produktivitas:", kolerasi_kedelai_Sumatera2)
```
Koefisien Korelasi Pearson Rata-rata curah hujan dan Produktivitas: 0.044

### Uji Granger Causality Kacang Kedelai
```{r}
# Melakukan uji Granger Causality 
granger_kedelai_Sumatera1 <- causality(var_model_kk, cause = "avg_rainfall")
granger_kedelai_Sumatera1

#Uji Granger Causality digunakan untuk menguji apakah suatu variabel dapat digunakan untuk memprediksi variabel lain dalam model VAR
```
Granger= p-value =0.2989 dan  instant = p-value = 0.05737
*kesimpulan*
Berdasarkan hasil uji Granger Causality, tidak terdapat bukti yang cukup untuk menyatakan bahwa avg_rainfall secara signifikan menyebabkan Granger dan instant untuk Produksi dan Produktivitas. 


### Uji regresi linier kedelai
```{r}
# Mengambil residual dari model VAR
residuals_var_kk <- resid(var_model_kk)

# Membuat model regresi linier
regresi_kedelai_produktivitas <- lm(Produktivitas ~ avg_rainfall , data = as.data.frame(residuals_var_kk))

# Ringkasan hasil model
summary(regresi_kedelai_produktivitas)
```
               Estimate Std. Error t value Pr(>|t|)  
(Intercept)  -1.184e-16  1.240e-01   0.000   1.0000  
avg_rainfall  2.616e-01  1.101e-01   2.375   0.0185 *
*Kesimpulan*
Terdapat bukti yang cukup (p-value sekitar0.0185 *) bahwa curah hujan (avg_rainfall) memiliki dampak pada Produktivitas. 

```{r}
# Membuat model regresi linier
regresi_kedelai_produksi <- lm(Produksi ~ avg_rainfall , data =as.data.frame(residuals_var_kk))

# Ringkasan hasil model
summary(regresi_kedelai_produksi)
```
Estimate Std. Error t value Pr(>|t|)    
 Estimate Std. Error t value Pr(>|t|)
(Intercept)   3.466e-13  8.576e+02   0.000    1.000
avg_rainfall -8.242e+02  7.618e+02  -1.082    0.281
*Kesimpulan*
Terdapat bukti bahwa curah hujan (avg_rainfall) tidak memiliki dampak yang signifikan pada Produksi. N

## Interpretasi kacang kedelai
Berdasarkan hasil analisis dengan model VAR, analisis kausalitas, dan regresi linear ini, kita dapat menyimpulkan bahwa avg_rainfall tidak mempergaruhi produksi dan produktivitas Kacang Kedelai di Sumatera.

### Prediksi dengan GARCH
```{r}
# Mengekstrak residu dari model VAR
residual_kedelai <- residuals(var_model_kk)
```

```{r}
# Buat data frame baru dari nilai residu
residu_var_kk <- data.frame(residual_kedelai)
# Tampilkan data frame baru
print(residu_var_kk)
```

```{r}
 #Mengecek outlier
boxplot(residual_kedelai, main = "Boxplot of Residuals", ylab = "Residuals")
# Mengecek normalitas data
shapiro.test(residual_kedelai)
```

```{r}
# karena model garch mengunakan distribusi normal, maka perlu mengecek data berdistribusi normal atau tidak
shapiro.test(train_data_kk$Produksi)
shapiro.test(train_data_kk$Produktivitas)
shapiro.test(train_data_kk$avg_rainfall)
```

```{r}
# Membuat data frame baru dengan transformasi kuadrat
df_kuadrat <- data.frame(Produksi_kuadrat = residu_var_kk$Produksi^2)
df_kuadrat
```

```{r}
# Membuat data frame baru dengan transformasi kuadrat akar
df_akar <- data.frame(Produksi_akar = sqrt(pmax(residu_var_kk$Produksi, 0)))
```

```{r}
# Buat objek data frame baru dengan transformasi Box-Cox
df_boxcox <- data.frame(Produksi_boxcox = BoxCox(residu_var_kk$Produksi, lambda = "auto"))
```

```{r}
# Transformasi residual menggunakan transformasi logaritma
residu_var_kk$Produksi_log <- log(abs(residu_var_kk$Produksi) + 1)
```

```{r}
shapiro.test(df_kuadrat$Produksi)
shapiro.test(df_boxcox$Produksi_boxcox)
shapiro.test(residu_var_kk$Produksi_log)
shapiro.test(df_akar$Produksi_akar)
```

```{r}
# Memodelkan GARCH pada residu VAR
garch_model <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
                           mean.model = list(armaOrder = c(0, 0)))
```

```{r}
# Estimasi parameter GARCH
garch_fit_ptkk <- ugarchfit(spec = garch_model, data = residu_var_kk$Produktivitas)
# Menampilkan ringkasan model GARCH
show(garch_fit_ptkk)
```
```{r}
# Menyimpan hasil prediksi
prediksi_garch_ptkk <- ugarchforecast(garch_fit_ptkk, n.ahead = 10)
prediksi_garch_ptkk
```


```{r}
# Estimasi parameter GARCH
garch_fit_avgkk <- ugarchfit(spec = garch_model, data = residu_var_kk$avg_rainfall)
# Menampilkan ringkasan model GARCH
show(garch_fit_avgkk)
```
```{r}
# Menyimpan hasil prediksi
prediksi_garch_avgkk <- ugarchforecast(garch_fit_avgkk, n.ahead = 10)
prediksi_garch_avgkk
```


```{r}
# Estimasi parameter GARCH
garch_fit_pjkk <- ugarchfit(spec = garch_model, data = residu_var_kk$Produksi_log)
# Menampilkan ringkasan model GARCH
show(garch_fit_pjkk)
```
```{r}
# Menyimpan hasil prediksi
prediksi_garch_pjkk <- ugarchforecast(garch_fit_pjkk, n.ahead = 10)
prediksi_garch_pjkk
```
                                                                                                          
                                                                                                          
```{r}
# Mengambil nilai prediksi GARCH dan membuat menjadi data frame
Prediksi_garch_kedelai <- data.frame(Produksi = as.numeric(prediksi_garch_pjkk@forecast$seriesFor[, 1]),
                                    Avg_Rainfall = as.numeric(prediksi_garch_avgkk@forecast$seriesFor[, 1]),
                                    Produktivitas = as.numeric(prediksi_garch_ptkk@forecast$seriesFor[, 1]))
Prediksi_garch_kedelai
```

```{r}
# Menambahkan kolom tahun
Prediksi_garch_kedelai$Tahun <- seq(2023, 2032)
# Menampilkan data frame
Prediksi_garch_kedelai
```

```{r}
# Visualisasi tren produksi kedelai
plot_tren_produksi <- ggplot(Prediksi_garch_kedelai
                             , aes(x = Tahun, y = Produksi, color = "Prediksi")) +
  geom_line() +
  geom_point() +
  labs(title = "Prediksi Tren Produksi Kedelai Sumatera (2023-2033)",
       x = "Tahun",
       y = "Produksi Jagung",
       color = "Metode Prediksi") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(legend.position = "right")

# Menampilkan plot
print(plot_tren_produksi)
```
```{r}
# Mengambil data produksi jagung selama 10 tahun terakhir
data_aktual_kedelai <- Sumatera_Kedelai[format(Sumatera_Kedelai$Tahun, "%Y") >= "2013", "Produksi"]
data_aktual_kedelai
```


```{r}
prediksi_produksi_kk <-Prediksi_garch_kedelai$Produksi
prediksi_produksi_kk
```
```{r}
data_aktual_kedelai <- as.numeric(data_aktual_kedelai)
```
```{r}
data_aktual_kedelai <- as.numeric(data_aktual_kedelai$Produksi)
```

```{r}
data_aktual_kedelai <- as.numeric(unlist(data_aktual_kedelai))
```

```{r}
prediksi_produksi_kk <- as.numeric(prediksi_produksi_kk)
```

```{r}
prediksi_produksi_kk <- as.numeric(Prediksi_garch_kedelai$Produksi)
```

```{r}
prediksi_produksi_kk <- as.numeric(unlist(Prediksi_garch_kedelai$Produksi))
```


```{r}
# Menghitung nilai RMSE, MAPE, MAE, dan MSE
rmse_garch_kk <- sqrt(mean((data_aktual_kedelai - prediksi_produksi_kk)^2))
mape_garch_kk <- mean(abs((data_aktual_kedelai - prediksi_produksi_kk) / data_aktual_kedelai) * 100)
mae_garch_kk <- mean(abs(data_aktual_kedelai - prediksi_produksi_kk))
mse_garch_kk <- mean((data_aktual_kedelai - prediksi_produksi_kk)^2)


cat("MAPE from garch:", mape_garch_kk, "%\n")
cat("RMSE:", rmse_garch_kk, "\n")
cat("MAE:", mae_garch_kk, "\n")
cat("MSE:", mse_garch_kk, "\n")

```


# Menampilkan data frame hasil evaluasi


### Prediksi Kedelai dengan Model VAR
```{r}
# Melakukan prediksi pada data testing
predictions_kedelai_var <- predict(var_model_kk, n.ahead = nrow(test_data_kk))
predictions_kedelai_var
```

```{r}
# Mengambil hanya kolom "fcst" dari setiap variabel
results_fcst_kedelai <- lapply(predictions_kedelai_var$fcst, function(x) x[, "fcst"])
# Menampilkan hasil
print(results_fcst_kedelai)
```

### Evaluasi model Produksi
```{r}
actual_produksi_kedelai <- test_data_kk$Produksi
```

```{r}
predicted_produksi_kedelai <- results_fcst_kedelai$Produksi
```

```{r}
#cek length
length(actual_produksi_kedelai)
length(predicted_produksi_kedelai)
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
epsilon <- 1e-10  # Nilai kecil untuk menghindari pembagian dengan nol
mape_kedelai_pro <- mean(abs((actual_produksi_kedelai-predicted_produksi_kedelai)/pmax(actual_produksi_kedelai, epsilon)))*100
rmse_kedelai_pro <- sqrt(mean((actual_produksi_kedelai-predicted_produksi_kedelai)^2))
mae_kedelai_pro <- mean(abs(actual_produksi_kedelai-predicted_produksi_kedelai))
mse_kedelai_pro <- mean((actual_produksi_kedelai-predicted_produksi_kedelai)^2)

cat("MAPE_kedelai:", mape_kedelai_pro, "\n")
cat("RMSE_kedelai:", rmse_kedelai_pro, "\n")
cat("MAE_kedelai:", mae_kedelai_pro, "\n")
cat("MSE_kedelai:", mse_kedelai_pro, "\n")
```
MAPE_kedelai: 50139.61 
RMSE_kedelai: 31102.75 
MAE_kedelai: 14898.42 
MSE_kedelai: 967380887

### Evaluasi model Produktivitas
```{r}
actual_produktivitas_kedelai <- test_data_kk$Produktivitas
```

```{r}
predicted_produktivitas_kedelai <- results_fcst_kedelai$Produktivitas
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
epsilon <- 1e-10  # Nilai kecil untuk menghindari pembagian dengan nol
mape_kedelai_pt <- mean(abs((actual_produktivitas_kedelai - predicted_produktivitas_kedelai) / pmax(actual_produktivitas_kedelai, epsilon))) * 100
rmse_kedelai_pt <- sqrt(mean((actual_produktivitas_kedelai- predicted_produktivitas_kedelai)^2))
mae_kedelai_pt <- mean(abs(actual_produktivitas_kedelai - predicted_produktivitas_kedelai))
mse_kedelai_pt <- mean((actual_produktivitas_kedelai - predicted_produktivitas_kedelai)^2)

cat("MAPE_kedelai:", mape_kedelai_pt, "\n")
cat("RMSE_kedelai:", rmse_kedelai_pt, "\n")
cat("MAE_kedelai:", mae_kedelai_pt, "\n")
cat("MSE_kedelai:", mse_kedelai_pt, "\n")
```
MAPE_kedelai: 20.59764 
RMSE_kedelai: 2.673551 
MAE_kedelai: 2.290757 
MSE_kedelai: 7.147877 

## 4. kacang Tanah Sumatera

```{r}
# Pilih variabel yang akan diprediksi

data_var_kacang_tanah <- Sumatera_kacang_tanah[, c("Produksi", "avg_rainfall", "Produktivitas")]
data_var_kacang_tanah
```

```{r}
# membagi data berdasarkan variabel avg_rainfall
set.seed(123)
train_index_kt <- createDataPartition(data_var_kacang_tanah$avg_rainfall, p=0.8, list = FALSE)
train_data_kt <- data_var_kacang_tanah [train_index_kt,] #pelatih
train_data_kt
test_data_kt <- data_var_kacang_tanah[-train_index_kt,] #penguji
test_data_kt
```

Untuk mendukung prediksi dengan Model VAR, data harus dirubah kedalam format time series (ts)
```{r}
ts_train_kt <-ts(train_data_kt, start = c(1993, 1), frequency = 1 )
ts_train_kt
```

```{r}
ts_test_kt <-ts(test_data_kt, start = c(1993, 1), frequency = 1 )
ts_test_kt
```


```{r}
best_lag_kt <- VARselect(ts_train_kt, lag.max = 5, type = "both")
best_lag_kt
```

### VAR Model terhadap produksi kacang tanah Sumatera
```{r}

var_model_kt_Sumatera <- VAR(ts_train_kt, p = best_lag_kt$selection[1], type = "both") # jumlah order dari model VAR
summary(var_model_kt_Sumatera)
```

Estimation results for equation Produksi: 
avg_rainfall.l4  -538.45377  171.67299  -3.137  0.00196 **

Estimation results for equation Produktivitas: 
avg_rainfall.l4   1.716e-01  7.619e-02   2.253 0.025335 * 

Terdapat bukti yg menunjukan bahwa avg_rainfal berdampak terhadap produksi dan produktivitas di lag 4

```{r}
# Hitung FEVD
fevd_result_kt <- fevd(var_model_kt_Sumatera)

# Plot FEVD untuk setiap variabel
plot(fevd_result_kt)
```


### Uji Kolersi Pearson kacang tanah
```{r}
# Menghitung koefisien korelasi Pearson
kolerasi_kt1 <- cor(test_data_kt$avg_rainfall, test_data_kt$Produksi)
cat ("Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi:",kolerasi_kt1)
```
Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi: -0.06

```{r}
# Menghitung koefisien korelasi Pearson
kolerasi_kt2 <- cor(test_data_kt$avg_rainfall, test_data_kt$Produktivitas)
cat ("Koefisien Korelasi Pearson rata-rata curah hujan dan Produktivitas:", kolerasi_kt2)
```
Koefisien Korelasi Pearson rata-rata curah hujan dan Produktivitas :  -0.04789687


### Uji Granger Causality Kacang Tanah
```{r}
# Melakukan uji Granger Causality 
granger_kt1 <- causality(var_model_kk, cause = "avg_rainfall")
granger_kt1

#Uji Granger Causality digunakan untuk menguji apakah suatu variabel dapat digunakan untuk memprediksi variabel lain dalam model VAR
```
Granger p-value = 0.2989
Instant p-value =0.05737


### Uji regresi linier Kacang Tanah
```{r}
# Mengambil residual dari model VAR
residuals_var_kt <- resid(var_model_kt_Sumatera)

# Membuat model regresi linier
regresi_kt_produksi<- lm(Produksi ~ avg_rainfall , data =as.data.frame(residuals_var_kt))

# Ringkasan hasil model
summary(regresi_kt_produksi)
```
   Estimate Std. Error t value Pr(>|t|)
(Intercept)  -4.201e-14  1.884e+02   0.000    1.000
avg_rainfall  7.585e+01  1.739e+02   0.436    0.663

*Kesimpulan* produksi kacang tanah tidak di perngaruhi oleh avg_rainfall. 

```{r}
# Membuat model regresi linier
regresi_kt_produktivitas<- lm(Produktivitas ~ avg_rainfall , data = as.data.frame(residuals_var_kt))

# Ringkasan hasil model
summary(regresi_kt_produktivitas)
```
 Estimate Std. Error t value Pr(>|t|)    
(Intercept)  1.219e-17  8.363e-02   0.000    1.000
avg_rainfall 1.840e-02  7.719e-02   0.238    0.812

*Kesimpulan* Tidak terdapat pengaruh curah hujan terhadap produktivitas kacang tanah.

## Interpretasi
Terdapat pengaruh avg_rainfall terhadap produksi dan produktivitas Berdasarkan hasil analisis dengan model VAR, analisis kausalitas, dan regresi linear ini:

1. Dalam model VAR, bahwa variabel avg_rainfall berdampak pada produktivitas kacang tanah  karena nilai P-Value dari lag4 yg lebih rendah dari 0,05 yaitu 0.025335* . serta avg_rainfall  berdampak pada produksi kacang tanah karena nilai P-Value dari dan lag4 lebih keceil dari 0,05 yaitu 0.00196**.

2. Berdasarkan hasil uji Granger Causality dan Instantaneous Causality, ada bukti statistik yang kuat untuk mendukung adanya hubungan sebab-akibat antara "avg_rainfall"  terhadap "Produksi" dan "Produktivitas" dalam model VAR dalam jangka waktu instan.

3. Berdasarkan hasil analisis kolerasi didapatkan bahwa variabel "avg_rainfall"memiliki pengaruh yang signifikan terhadap variabel "Produktivitas," dan produksi walaupun kecil.

# Prediksi Model VAR
```{r}
# Melakukan prediksi pada data testing
predictions_kt <- predict(var_model_kt_Sumatera, n.ahead = length(ts_train_kt))
predictions_kt
```

### Evaluasi model
```{r}
actual_values_kt <- test_data_kt$Produksi 
predicted_values_kt <- as.vector(predictions_kt$fcst$Produksi)
```

```{r}
# Trim data prediksi agar panjangnya sesuai dengan data aktual agar dapat diukur perfomanya
predicted_values_kt <- head(predicted_values_kt, length(actual_values_kt))
```

```{r}
#cek length
length(actual_values_kt)
length(predicted_values_kt)
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
mape_kt <- mean(abs((actual_values_kt - predicted_values_kt) / actual_values_kt)) * 100
rmse_kt <- sqrt(mean((actual_values_kt - predicted_values_kt)^2))
mae_kt <- mean(abs(actual_values_kt - predicted_values_kt))
mse_kt <- mean((actual_values_kt - predicted_values_kt)^2)
```

```{r}
cat("MAPE_kt:", mape_kt, "\n")
cat("RMSE_kt:", rmse_kt, "\n")
cat("MAE_kt:", mae_kt, "\n")
cat("MSE_kt:", mse_kt, "\n")
```
 


### Prediksi kacang tanah dengan Model VAR
```{r}
# Melakukan prediksi pada data testing
predictions_kt_var <- predict(var_model_kt_Sumatera, n.ahead = nrow(test_data_kt))
predictions_kt_var
```

```{r}
# Mengambil hanya kolom "fcst" dari setiap variabel
results_fcst_kt <- lapply(predictions_kt_var$fcst, function(x) x[, "fcst"])
# Menampilkan hasil
print(results_fcst_kt)
```

### Evaluasi model Produksi
```{r}
actual_produksi_kt <- test_data_kt$Produksi
```

```{r}
predicted_produksi_kt <- results_fcst_kt$Produksi
```

```{r}
#cek length
length(actual_produksi_kt)
length(predicted_produksi_kt)
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
epsilon <- 1e-10  # Nilai kecil untuk menghindari pembagian dengan nol
mape_kt_pro <- mean(abs((actual_produksi_kt-predicted_produksi_kt)/pmax(actual_produksi_kt, epsilon)))*100
rmse_kt_pro <- sqrt(mean((actual_produksi_kt-predicted_produksi_kt)^2))
mae_kt_pro <- mean(abs(actual_produksi_kt-predicted_produksi_kt))
mse_kt_pro <- mean((actual_produksi_kt-predicted_produksi_kt)^2)

cat("MAPE_kacangtanah:", mape_kt_pro, "\n")
cat("RMSE_kacangtanah:", rmse_kt_pro, "\n")
cat("MAE_kacangtanah:", mae_kt_pro, "\n")
cat("MSE_kacangtanah:", mse_kt_pro, "\n")
```
MAPE_kacangtanah: 1290.035 
RMSE_kacangtanah: 8487.753 
MAE_kacangtanah: 7350.532 
MSE_kacangtanah: 72041955



### Evaluasi model Produktivitas
```{r}
actual_produktivitas_kt <- test_data_kt$Produktivitas
```

```{r}
predicted_produktivitas_kt <- results_fcst_kt$Produktivitas
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
epsilon <- 1e-10  # Nilai kecil untuk menghindari pembagian dengan nol
mape_kt_pt <- mean(abs((actual_produktivitas_kt - predicted_produktivitas_kt) / pmax(actual_produktivitas_kt, epsilon))) * 100
rmse_kt_pt <- sqrt(mean((actual_produktivitas_kt- predicted_produktivitas_kt)^2))
mae_kt_pt <- mean(abs(actual_produktivitas_kt - predicted_produktivitas_kt))
mse_kt_pt <- mean((actual_produktivitas_kt - predicted_produktivitas_kt)^2)

cat("MAPE_kacangtanah:", mape_kt_pt, "\n")
cat("RMSE_kacangtanah:", rmse_kt_pt, "\n")
cat("MAE_kacangtanah:", mae_kt_pt, "\n")
cat("MSE_kacangtanah:", mse_kt_pt, "\n")
```
MAPE_kacangtanah: 12.73382 
RMSE_kacangtanah: 1.712434 
MAE_kacangtanah: 1.408061 
MSE_kacangtanah: 2.932431

MAPE_kt: 11.43724 
RMSE_kt: 1.570883 
MAE_kt: 1.278067 
MSE_kt: 2.467673 

# 5. Ubi Jalar Sumatera

```{r}
# Pilih variabel yang akan diprediksi

data_var_ubijalar <- Sumatera_ubi_jalar[, c("Produksi", "avg_rainfall", "Produktivitas")]
data_var_ubijalar
```

```{r}
# membagi data berdasarkan variabel avg_rainfall
set.seed(123)
train_index_uj <- createDataPartition(data_var_ubijalar$avg_rainfall, p=0.8, list = FALSE)
train_data_uj <- data_var_ubijalar[train_index_uj,] #pelatih
train_data_uj
test_data_uj <- data_var_ubijalar[-train_index_uj,] #penguji
test_data_uj
```

Untuk mendukung prediksi dengan Model VAR, data harus dirubah kedalam format time series (ts)
```{r}
ts_train_uj <-ts(train_data_uj, start = c(1993, 1), frequency = 1 )
ts_train_uj
```

```{r}
ts_test_uj <-ts(test_data_uj, start = c(1993, 1), frequency = 1 )
ts_test_uj
```
 
```{r}
best_lag_uj_Sumatera<- VARselect(ts_train_uj, lag.max = 5, type = "both")
best_lag_uj_Sumatera
```

### VAR Model terhadap produksi Ubi Jalar Sumatera
```{r}

var_model_uj_Sumatera <- VAR(ts_train_uj, p = best_lag_uj_Sumatera$selection[1], type = "both") # jumlah order dari model VAR
summary(var_model_uj_Sumatera)
```
tidak terdapat pengaruh curah hujan terhadap produksi dan produktivitas

```{r}
# Hitung FEVD
fevd_result_uj <- fevd(var_model_uj_Sumatera)

# Plot FEVD untuk setiap variabel
plot(fevd_result_uj)
```


### Uji Kolersi Pearson Ubi Jalar
```{r}
# Menghitung koefisien korelasi Pearson
kolerasi_uj_Sumatera1 <- cor(test_data_uj$Produksi, test_data_uj$avg_rainfall)
cat ("Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi:",kolerasi_uj_Sumatera1)
```
Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi: 0.21


```{r}
# Menghitung koefisien korelasi Pearson
kolerasi_uj_Sumatera2 <- cor(test_data_uj$avg_rainfall, test_data_uj$Produktivitas)
cat ("Koefisien Korelasi Pearson Rata-rata curah hujan dan produksi:", kolerasi_uj_Sumatera2)
```
Koefisien Korelasi Pearson Rata-rata curah hujan dan produksi: 0.16


### Uji Granger Causality ubi jalar
```{r}
# Melakukan uji Granger Causality 
granger_uj_Sumatera1 <- causality(var_model_uj_Sumatera, cause = "avg_rainfall")
granger_uj_Sumatera1

#Uji Granger Causality digunakan untuk menguji apakah suatu variabel dapat digunakan untuk memprediksi variabel lain dalam model VAR
```
Granger p-value = 0.1107
Instant  p-value = 0.2059
terdapat bukti signifikan sebab akibat avg-rainfall terhadap produksi dan produksivitas dalam jangkah panjang tetapi tidak di jangka instant



### Uji regresi linier Ubi jalar
```{r}
# Mengambil residual dari model VAR
residuals_var_uj <- resid(var_model_uj_Sumatera) 

# Membuat model regresi linier
regresi_uj_produktivitas <- lm(Produktivitas ~ avg_rainfall, data =as.data.frame(residuals_var_uj))

# Ringkasan hasil model
summary(regresi_uj_produktivitas)
```
Coefficients:
              Estimate Std. Error t value Pr(>|t|)  
(Intercept)  2.777e-17  2.381e+00   0.000   1.0000  
avg_rainfall 3.735e+00  2.084e+00   1.793   0.0744 .
Multiple R-squared:  0.02511,	Adjusted R-squared:  0.0216 
F-statistic:  7.16 on 1 and 278 DF,  p-value: 0.007898


```{r}
# Membuat model regresi linier
regresi_uj_produksi <- lm(Produksi ~ avg_rainfall, data = as.data.frame(residuals_var_uj))

# Ringkasan hasil model
summary(regresi_uj_produksi)
```
oefficients:
              Estimate Std. Error t value Pr(>|t|)
(Intercept)  9.160e-13  1.184e+03   0.000    1.000
avg_rainfall 3.325e+02  1.036e+03   0.321    0.749

## Interpretasi
Terdapat dapat avg_Rainfall terhadap produksi dan produktivitas, Berdasarkan hasil analisis dengan model VAR, analisis kausalitas, dan regresi linear ini, kita dapat menyimpulkan bahwa curah hujan tidak berdampak terhadap produksi dan produktivitas.


# Prediksi Model VAR
```{r}
# Melakukan prediksi pada data testing
predictions_uj <- predict(var_model_uj_Sumatera, n.ahead = length(ts_train_uj))
predictions_uj
```

## Evaluasi model
```{r}
actual_values_uj <- test_data_uj$Produksi  
predicted_values_uj <- as.vector(predictions_uj$fcst$Produksi)
```

```{r}
# Trim data prediksi agar panjangnya sesuai dengan data aktual agar dapat diukur perfomanya
predicted_values_uj <- head(predicted_values_uj, length(actual_values_uj))
```

```{r}
#cek length
length(actual_values_uj)
length(predicted_values_uj)
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
mape_uj <- mean(abs((actual_values_uj - predicted_values_uj) / actual_values_uj)) * 100
rmse_uj  <- sqrt(mean((actual_values_uj - predicted_values_uj)^2))
mae_uj  <- mean(abs(actual_values_uj - predicted_values_uj))
mse_uj  <- mean((actual_values_uj - predicted_values_uj)^2)
```

```{r}
cat("MAPE:", mape_uj , "\n")
cat("RMSE:", rmse_uj , "\n")
cat("MAE:", mae_uj , "\n")
cat("MSE:", mse_uj , "\n")
```


### Prediksi produktivitas 

# Prediksi Model VAR
```{r}
# Melakukan prediksi pada data testing
predictions_uj <- predict(var_model_uj_Sumatera, n.ahead = length(ts_train_uj))
predictions_uj
```

```{r}
actual_values_ptuj <- test_data_uj$Produktivitas
predicted_values_ptuj <- as.vector(predictions_uj$fcst$Produktivitas)
```

```{r}
# Trim data prediksi agar panjangnya sesuai dengan data aktual agar dapat diukur perfomanya
predicted_values_ptuj <- head(predicted_values_ptuj, length(actual_values_ptuj))
```

```{r}
#cek length
length(actual_values_ptuj)
length(predicted_values_ptuj)
```

```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
mape_ptuj <- mean(abs((actual_values_ptuj - predicted_values_ptuj) / actual_values_ptuj)) * 100
rmse_ptuj  <- sqrt(mean((actual_values_ptuj - predicted_values_ptuj)^2))
mae_ptuj  <- mean(abs(actual_values_ptuj - predicted_values_ptuj))
mse_ptuj  <- mean((actual_values_ptuj - predicted_values_ptuj)^2)
```

```{r}
cat("MAPE:", mape_ptuj , "\n")
cat("RMSE:", rmse_ptuj , "\n")
cat("MAE:", mae_ptuj , "\n")
cat("MSE:", mse_ptuj , "\n")
```
MAPE: 48.18636 
RMSE: 77.39889 
MAE: 59.38653 
MSE: 5990.588



## 6. Ubi Kayu Sumatera

```{r}
# Pilih variabel yang akan diprediksi

data_var_ubikayu <- Sumatera_ubi_kayu[, c("Produksi", "avg_rainfall", "Produktivitas")]
data_var_ubikayu
```

```{r}
# membagi data berdasarkan variabel avg_rainfall
set.seed(123)
train_index_uk <- createDataPartition(data_var_ubikayu$avg_rainfall, p=0.8, list = FALSE)
train_data_uk <- data_var_ubikayu[train_index_uk,] #pelatih
train_data_uk
test_data_uk <- data_var_ubikayu[-train_index_uk,] #penguji
test_data_uk
```

Untuk mendukung prediksi dengan Model VAR, data harus dirubah kedalam format time series (ts)
```{r}
ts_train_uk <-ts(train_data_uk, start = c(1993, 1), frequency = 1 )
ts_train_uk
```

```{r}
ts_test_uk <-ts(test_data_uk, start = c(1993, 1), frequency = 1 )
ts_test_uk
```

```{r}
best_lag_uk_Sumatera<- VARselect(ts_train_uk, lag.max = 5, type = "both")
best_lag_uk_Sumatera
```


### VAR Model terhadap produksi ubi kayu Sumatera
```{r}

var_model_uk_Sumatera <- VAR(ts_train_uk, p = best_lag_uk_Sumatera$selection[1], type = "both") # jumlah order dari model VAR
summary(var_model_uk_Sumatera)
```

Estimation results for equation produksi: 
avg_rainfall.l5  -6.864e+04  2.993e+04  -2.293 0.022866 *   
p-value: < 2.2e-16 
 
Estimation results for equation Produktivitas: 
avg_rainfall.l1  -1.068e+01  3.085e+00  -3.461 0.000657 *** 
avg_rainfall.l3   6.186e+00  3.127e+00   1.978 0.049296 * 
p-value: < 2.2e-16  

```{r}
# Hitung FEVD
fevd_result_uk <- fevd(var_model_uk_Sumatera)

# Plot FEVD untuk setiap variabel
plot(fevd_result_uk)
```
## Uji Kolersi Pearson uk
```{r}
# Misalnya, uji korelasi antara Produksi dan avg_rainfall
kolerasi_uk_Sumatera1<-cor(test_data_uk$Produksi, test_data_uk$avg_rainfall, method = "pearson")
cat ("Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi:",kolerasi_uk_Sumatera1)

```
Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produksi: -0.08



```{r}
# Misalnya, uji korelasi antara Produktivitas dan avg_rainfall
kolerasi_uk_Sumatera2<-cor(test_data_uk$Produktivitas, test_data_uk$avg_rainfall, method = "pearson")
cat ("Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produktivitas:",kolerasi_uk_Sumatera2)

```
Koefisien Korelasi Pearson Rata-rata Curah hujan dan Produktivitas : 0.13


### Uji Granger Causality uk
```{r}
# Melakukan uji Granger Causality 
granger_uk_Sumatera1 <- causality(var_model_uk_Sumatera, cause = "avg_rainfall")
granger_uk_Sumatera1

#Uji Granger Causality digunakan untuk menguji apakah suatu variabel dapat digunakan untuk memprediksi variabel lain dalam model VAR
``` 
Granger p-value = 0.00151 dan Instant  p-value = 0.7142  terdapat bukti statistik hubungan jangka lag maupun antara avg_rainfal, produksi, produktivitas tetapi tidak pada instant


### Uji regresi linier uk
```{r}
# Mengambil residual dari model VAR
residuals_var_uk <- resid(var_model_uk_Sumatera)

# Membuat model regresi linier
regresi_uk_produksi<- lm(Produksi ~ avg_rainfall, data =as.data.frame(residuals_var_uk))

# Ringkasan hasil model
summary(regresi_uk_produksi)
```
Coefficients:
               Estimate Std. Error t value Pr(>|t|)
(Intercept)  -3.846e-12  3.074e+04   0.000    1.000
avg_rainfall  1.698e+04  2.858e+04   0.594    0.553           
p-value: 0.553


```{r}
# Membuat model regresi linier
regresi_uk_Sumatera_produktivitas <- lm(Produktivitas~ avg_rainfall , data = as.data.frame(residuals_var_uk))

# Ringkasan hasil model
summary(regresi_uk_Sumatera_produktivitas)
```
Estimate Std. Error t value Pr(>|t|)
(Intercept)  2.902e-16  3.283e+00   0.000    1.000
avg_rainfall 1.747e+00  3.053e+00   0.572    0.568
p-value: 0.5677


## Interpretasi
Berdasarkan hasil analisis dengan model VAR, analisis kausalitas, dan regresi linear ini, kita dapat menyimpulkan bahwa:

1. Dalam model VAR, bahwa variabel avg_rainfall berdampak pada *produktivitas* ubi kayu  karena nilai P-Value dari  lag yaitu  Lag1, Lag3 yg  lebih rendah dari 0,05. dan  avg_rainfall  berdampak pada produksi jagung di lag 5 karena nilai P-Value lebih besar dari 0,05  

2. Berdasarkan hasil uji Granger Causality dan Instantaneous Causality, ada bukti statistik yang kuat untuk mendukung adanya hubungan sebab-akibat antara "avg_rainfall" terhadap "Produktivitas" dan produksi dalam model VAR dalam jangka waktu lag tetapi bukan dalam jangka waktu instan. 

3. Berdasarkan hasil analisis regresi didapatkan bahwa variabel "avg_rainfall" tidak memiliki pengaruh yang signifikan terhadap variabel "Produktivitas,"dan "produksi" Ubi kayu.

# Prediksi Model VAR
```{r}
# Melakukan prediksi pada data testing
predictions_uk <- predict(var_model_uk_Sumatera, n.ahead = length(ts_train_uk))
```

## Prediksi produksi
```{r}
actual_values_uk <- test_data_uk$Produksi  
predicted_values_uk <- as.vector(predictions_uk$fcst$Produksi)
```

```{r}
# Trim data prediksi agar panjangnya sesuai dengan data aktual agar dapat diukur perfomanya
predicted_values_uk <- head(predicted_values_uk, length(actual_values_uk))
```

```{r}
#cek length
length(actual_values_uk)
length(predicted_values_uk)
```
### Evaluasi model 
```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
mape_uk <- mean(abs((actual_values_uk - predicted_values_uk) / actual_values_uk)) * 100
rmse_uk <- sqrt(mean((actual_values_uk - predicted_values_uk)^2))
mae_uk <- mean(abs(actual_values_uk - predicted_values_uk))
mse_uk <- mean((actual_values_uk - predicted_values_uk)^2)

cat("MAPE:", mape_uk, "\n")
cat("RMSE:", rmse_uk, "\n")
cat("MAE:", mae_uk, "\n")
cat("MSE:", mse_uk, "\n")
```
MAPE: 1939.144 
RMSE: 2021017 
MAE: 1276346 
MSE: 4.08451e+12 

### Prediksi Produktivitas
```{r}
actual_values_ptuk <- test_data_uk$Produktivitas 
predicted_values_ptuk <- as.vector(predictions_uk$fcst$Produktivitas)
```

```{r}
# Trim data prediksi agar panjangnya sesuai dengan data aktual agar dapat diptukur perfomanya
predicted_values_ptuk <- head(predicted_values_ptuk, length(actual_values_ptuk))
```

```{r}
#cek length
length(actual_values_ptuk)
length(predicted_values_ptuk)
```
### Evaluasi model 
```{r}
# Mengukur performa dengan MAPE, RMSE,MAE,MSE
mape_ptuk <- mean(abs((actual_values_ptuk - predicted_values_ptuk) / actual_values_ptuk)) * 100
rmse_ptuk <- sqrt(mean((actual_values_ptuk - predicted_values_ptuk)^2))
mae_ptuk <- mean(abs(actual_values_ptuk - predicted_values_ptuk))
mse_ptuk <- mean((actual_values_ptuk - predicted_values_ptuk)^2)

cat("MAPE:", mape_ptuk, "\n")
cat("RMSE:", rmse_ptuk, "\n")
cat("MAE:", mae_ptuk, "\n")
cat("MSE:", mse_ptuk, "\n")
```

MAPE: 63.43169 
RMSE: 116.3499 
MAE: 102.832 
MSE: 13537.3 

